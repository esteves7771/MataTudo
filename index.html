<!doctype html>
<html lang="en" data-theme="normal">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>MataTudo — Alpha 15.2</title>
<style>
  /* ---------- Instant theme (Retro toggle) ---------- */
  :root{
    --bg:#0b1220; --panel:#0c1528; --panel2:#0b1220; --text:#e9f1ff;
    --muted:#9fb3d6; --accent:#60a5fa; --ok:#34d27a; --warn:#fbbf24; --danger:#ef4444;
    --border:rgba(255,255,255,.1); --shadow:rgba(0,0,0,.35); --card:0 10px 30px rgba(0,0,0,.35);
  }
  [data-theme="retro"]{
    --bg:#0a0a0a; --panel:#0f0f0f; --panel2:#0b0b0b; --text:#ededed;
    --muted:#c7c7c7; --accent:#9ad1ff; --ok:#a8e6b8; --warn:#ffd470; --danger:#ff7a7a;
    --border:rgba(255,255,255,.12); --shadow:rgba(0,0,0,.55); --card:0 12px 36px rgba(0,0,0,.55);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--text);
       font:14px ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif}
  h1{margin:20px auto 10px;text-align:center;font-weight:800;letter-spacing:.2px}
  .wrap{
    max-width: 1600px; margin: 0 auto; padding: 0 16px 24px;
    display:grid; grid-template-columns: 280px minmax(980px,1fr) 300px; gap:20px;
    justify-items:center; align-items:start;
  }
  .panel{width:100%; background:var(--panel); border:1px solid var(--border);
         border-radius:14px; box-shadow:var(--card); padding:12px}
  .kv{display:flex;justify-content:space-between;padding:2px 0}
  .card{background:var(--panel2); border:1px solid var(--border); border-radius:12px; padding:10px; margin-top:10px}
  .muted{color:var(--muted)}
  .btn{padding:6px 10px;border:1px solid var(--border);border-radius:10px;background:transparent;color:var(--text);cursor:pointer}
  .btn:active{transform:translateY(1px)}
  .row{display:flex;align-items:center;gap:8px}
  .range{width:100%}
  .hpbar,.shieldbar{width:100%;background:rgba(255,255,255,.06);border:1px solid var(--border);border-radius:6px;position:relative;overflow:hidden}
  .hpbar{height:8px}.shieldbar{height:6px;margin-top:6px}
  .hpbar .fill,.shieldbar .fill{position:absolute;left:0;top:0;bottom:0}
  .hpbar .fill{background:var(--ok)} .shieldbar .fill{background:#7cc7ff}
  .tips{white-space:pre-line;font-size:12px;line-height:1.3}
  .canvasWrap{width:100%;max-width: 1180px; background:#000; border:1px solid var(--border); border-radius:18px; padding:8px; box-shadow:var(--card)}
  canvas{display:block;margin:0 auto;border-radius:12px;background:#000}
  .footer{margin:8px auto 0;text-align:center;font-size:12px;color:var(--muted)}
  .lb-list{list-style:none;margin:8px 0 0;padding:0;font-family:ui-monospace,Consolas,Menlo,monospace;font-size:12px}
  .lb-list li{display:flex;justify-content:space-between;border-bottom:1px dotted var(--border);padding:3px 0}
</style>
</head>
<body>
  <h1>MataTudo — Alpha 15.2</h1>
  <div class="wrap">
    <!-- LEFT -->
    <div class="panel">
      <div class="kv"><div>Score</div><div id="uiScore">0</div></div>
      <div class="kv"><div>Best</div><div id="uiBest">0</div></div>
      <div class="kv"><div>Level</div><div id="uiLevel">1</div></div>
      <div class="kv"><div>Mult</div><div id="uiMult">x1</div></div>
      <div class="kv"><div>Power</div><div id="uiPower">-</div></div>
      <div class="card">
        <div class="muted" style="font-size:12px;margin-bottom:4px">HP</div>
        <div class="hpbar"><div id="hpFill" class="fill" style="width:100%"></div></div>
        <div class="shieldbar"><div id="shFill" class="fill" style="width:0%"></div></div>
      </div>
      <div class="card">
        <div class="tips">Tips
• WASD / Arrows move
• Mouse aims • Click shoots (hold)
• M mute • R restart
• SPACE starts
• Level +1 every 30 kills
• Boss at 5,15,25,40,55,75…</div>
      </div>
      <div class="card">
        <div class="row">
          <button id="btnMute" class="btn">Mute</button>
          <span class="muted">Vol</span>
          <input id="rngVol" class="range" type="range" min="0" max="1" step="0.05" value="0.7" />
        </div>
      </div>
      <div class="card">
        <button id="btnPause" class="btn" style="width:100%">Pause</button>
      </div>
    </div>

    <!-- CENTER -->
    <div class="canvasWrap">
      <canvas id="game" width="980" height="560"></canvas>
      <div class="footer">Press <b>SPACE</b> to start • Retro toggle on the right • Obstacles fade & boss fights are back</div>
    </div>

    <!-- RIGHT -->
    <div class="panel">
      <div class="card">
        <div class="kv"><strong>Leaderboards</strong><span class="muted">Local</span></div>
        <div class="kv"><span>All‑Time (Local)</span><span id="uiAllTime">0</span></div>
        <div class="kv"><span>Your Best</span><span id="uiBest2">0</span></div>
        <div class="muted" style="margin-top:6px">Top 10</div>
        <ul id="uiTop10" class="lb-list"></ul>
      </div>
      <div class="card">
        <div class="kv"><strong>Retro Mode</strong><span class="muted">On</span></div>
        <label class="row" style="justify-content:space-between">
          <span class="muted">Greyscale + scanlines</span>
          <input id="retroToggle" type="checkbox" />
        </label>
      </div>
    </div>
  </div>

<script>
(() => {
  const cvs = document.getElementById('game');
  const ctx = cvs.getContext('2d', { alpha:false });

  // -------- Assets (music) --------
  const MUSIC_URL = "https://raw.githubusercontent.com/esteves7771/MataTudo/main/retro-synthwave-gaming-music-270173.mp3";
  const STING_URL  = "https://raw.githubusercontent.com/esteves7771/MataTudo/main/victory-awaits-in-the-gaming-universe_astronaut-265184.mp3";
  const music = new Audio(MUSIC_URL); music.loop = true; music.preload = 'auto'; music.crossOrigin='anonymous';
  const sting = new Audio(STING_URL);  sting.loop = false; sting.preload = 'auto'; sting.crossOrigin='anonymous';

  // -------- State --------
  const s = {
    mode:'menu', last:0, countdown:2,
    w:cvs.width, h:cvs.height,
    retro:false,
    // player
    p:{x:cvs.width/2,y:cvs.height/2,r:12,hp:100,shields:0,maxShields:2,spd:240,fireCD:0,flash:0,invuln:0},
    keys:Object.create(null), mouse:{x:cvs.width/2,y:cvs.height/2,down:false},
    // world
    bullets:[], bots:[], particles:[], medkits:[],
    obstacles: seedObstacles(),
    obstaclePhase:'stable', obstacleFadeT:0, obstacleAlpha:1,
    spawnT:0, score:0, best:0, level:1, kills:0,
    // bosses
    bossSchedule:[5,15,25,40,55,75,90,110,130,170,200,230,250],
    nextBossIdx:0, boss:null, bossActive:false, postBossCooldown:0,
    // audio
    ac:null, gMaster:null, muted:false, volume:0.7, armed:false,
    // leaderboards
    top10:loadTop10()
  };

  // -------- UI refs --------
  const uiScore=document.getElementById('uiScore'), uiBest=document.getElementById('uiBest'), uiBest2=document.getElementById('uiBest2'),
        uiLevel=document.getElementById('uiLevel'), uiMult=document.getElementById('uiMult'),
        hpFill=document.getElementById('hpFill'), shFill=document.getElementById('shFill'),
        btnPause=document.getElementById('btnPause'), btnMute=document.getElementById('btnMute'), rngVol=document.getElementById('rngVol'),
        retroToggle=document.getElementById('retroToggle'), uiAllTime=document.getElementById('uiAllTime'), uiTop10=document.getElementById('uiTop10');

  // restore best + theme
  try{ s.best = parseInt(localStorage.getItem('mt_best')||'0',10)||0; }catch{}
  try{ const t = localStorage.getItem('mt_visual_mode'); s.retro = (t==='retro'); }catch{}
  document.documentElement.setAttribute('data-theme', s.retro?'retro':'normal');
  retroToggle.checked = s.retro;

  // -------- Helpers --------
  const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
  function seedObstacles(){
    return [
      {x:280,y:180,w:90,h:90},
      {x:610,y:340,w:120,h:70},
      {x:440,y: 90,w:70,h:70},
      {x:120,y:400,w:140,h:40},
    ];
  }
  function rectCircleOverlap(cx,cy,r,o){
    const nx = clamp(cx,o.x,o.x+o.w), ny = clamp(cy,o.y,o.y+o.h);
    const dx=cx-nx, dy=cy-ny; return dx*dx+dy*dy <= r*r;
  }
  function bulletHitsObstacle(b,o){ return (b.x+b.r>o.x && b.x-b.r<o.x+o.w && b.y+b.r>o.y && b.y-b.r<o.y+o.h); }
  function posIsFree(x,y,r){
    if (x<12+r || x>s.w-12-r || y<12+r || y>s.h-12-r) return false;
    if (s.obstacles.some(o=>rectCircleOverlap(x,y,r,o))) return false;
    return true;
  }
  function addParticles(x,y,col,count=12,size=2,spd=120){
    for(let i=0;i<count;i++){
      const a=Math.random()*Math.PI*2, v=spd*(.5+Math.random());
      s.particles.push({x,y,vx:Math.cos(a)*v,vy:Math.sin(a)*v,life:.5+.4*Math.random(),c:col,sz:size});
    }
  }
  function rng(min,max){ return min + Math.random()*(max-min); }

  // -------- Audio (SFX minimal) --------
  function ensureAC(){
    if (s.armed && s.ac) return;
    const C=window.AudioContext||window.webkitAudioContext; if(!C) return;
    s.ac = new C(); s.gMaster=s.ac.createGain(); s.gMaster.gain.value = s.muted?0:s.volume; s.gMaster.connect(s.ac.destination);
    // arm HTMLAudio volume
    music.volume = s.muted?0:s.volume; sting.volume = s.muted?0:Math.min(0.8, s.volume*0.9);
    s.armed=true;
  }
  function beep(freq=900,dur=.06,type='square',gain=.03){
    if (s.muted) return; ensureAC(); if(!s.ac) return;
    const o=s.ac.createOscillator(), g=s.ac.createGain(); o.type=type; o.frequency.value=freq; g.gain.value=gain; o.connect(g).connect(s.gMaster);
    const t=s.ac.currentTime; g.gain.setValueAtTime(gain,t); g.gain.exponentialRampToValueAtTime(0.0001,t+dur); o.start(t); o.stop(t+dur);
  }

  // -------- UI actions --------
  btnPause.addEventListener('click', ()=>{
    if (s.mode==='playing'){ s.mode='menu'; cleanupTransients(); stopMusic(); }
    else if (s.mode==='menu'){ startGame(); }
  });
  btnMute.addEventListener('click', ()=>{
    s.muted=!s.muted;
    if (s.gMaster) s.gMaster.gain.value = s.muted?0:s.volume;
    music.volume = s.muted?0:s.volume; sting.volume = s.muted?0:Math.min(0.8,s.volume*0.9);
    btnMute.textContent = s.muted?'Unmute':'Mute';
  });
  rngVol.addEventListener('input', ()=>{
    s.volume=parseFloat(rngVol.value);
    if (s.gMaster && !s.muted) s.gMaster.gain.value=s.volume;
    music.volume = s.muted?0:s.volume; sting.volume = s.muted?0:Math.min(0.8,s.volume*0.9);
  });
  retroToggle.addEventListener('change', ()=>{
    s.retro = retroToggle.checked;
    try{ localStorage.setItem('mt_visual_mode', s.retro?'retro':'normal'); }catch{}
    document.documentElement.setAttribute('data-theme', s.retro?'retro':'normal');
  });

  // -------- Input --------
  function isEditing(){ const el=document.activeElement; return el && (el.tagName==='INPUT'||el.tagName==='TEXTAREA'||el.isContentEditable); }
  window.addEventListener('keydown',(e)=>{
    const k=e.key.toLowerCase();
    if (isEditing()){
      if (e.code==='Space' && (s.mode==='menu'||s.mode==='gameover')){ e.preventDefault(); startGame(); }
      if (k==='r' && s.mode==='gameover'){ e.preventDefault(); startGame(); }
      return;
    }
    if (!e.repeat) s.keys[k]=true;
    if (k==='m'){ s.muted=!s.muted; if(s.gMaster) s.gMaster.gain.value=s.muted?0:s.volume; music.volume=s.muted?0:s.volume; sting.volume=s.muted?0:Math.min(0.8,s.volume*0.9); btnMute.textContent=s.muted?'Unmute':'Mute'; }
    if (s.mode==='menu' && e.code==='Space'){ startGame(); }
    if (s.mode==='gameover' && (k==='r'||e.code==='Space')){ startGame(); }
  });
  window.addEventListener('keyup',(e)=>{ s.keys[e.key.toLowerCase()]=false; });

  function toLocal(e){
    const r=cvs.getBoundingClientRect();
    s.mouse.x = (e.clientX - r.left) * (s.w / r.width);
    s.mouse.y = (e.clientY - r.top)  * (s.h / r.height);
  }
  cvs.addEventListener('mousemove',toLocal);
  cvs.addEventListener('mousedown',(e)=>{ toLocal(e); s.mouse.down=true; if(s.mode==='menu'){ startGame(); } });
  window.addEventListener('mouseup',()=>{ s.mouse.down=false; });

  // -------- Start/Reset --------
  function startGame(){
    ensureAC();
    try{ music.currentTime=0; if(!s.muted) music.play().catch(()=>{}); }catch{}
    try{ sting.pause(); }catch{}
    s.mode='countdown'; s.countdown=2;
    s.p={x:s.w/2,y:s.h/2,r:12,hp:100,shields:0,maxShields:2,spd:240,fireCD:0,flash:0,invuln:0};
    s.bullets.length=0; s.bots.length=0; s.particles.length=0; s.medkits.length=0;
    s.obstacles = seedObstacles(); s.obstaclePhase='stable'; s.obstacleAlpha=1; s.obstacleFadeT=0;
    s.spawnT=0; s.score=0; s.level=1; s.kills=0;
    s.nextBossIdx=0; s.boss=null; s.bossActive=false; s.postBossCooldown=0;
  }
  function cleanupTransients(){ s.bullets.length=0; s.particles.length=0; s.medkits.length=0; }

  // -------- Boss logic --------
  function bossHPForIndex(i){
    // Base ~ old 120 * 3 = 360 → scale +20% per index
    const base = 360; return Math.floor(base * Math.pow(1.2, i));
  }
  function spawnBoss(){
    s.bossActive=true;
    // wipe enemy bullets
    s.bullets = s.bullets.filter(b=>b.owner==='p');
    const i=s.nextBossIdx, hp=bossHPForIndex(i);
    // spawn near center, not on player
    const bx = clamp(s.w/2 + rng(-80,80), 60, s.w-60);
    const by = clamp(s.h/2 + rng(-60,60), 60, s.h-60);
    s.boss = {x:bx,y:by,r:22,hp,max:hp,phase:1,cd:0,tele:0,dir:0};
  }
  function updateBoss(dt){
    if (!s.bossActive) return;
    const b=s.boss, p=s.p;
    if (!b) return;

    // Phase switch
    if (b.phase===1 && b.hp <= b.max*0.5){ b.phase=2; b.tele=0.9; } // telegraph dash

    // movement / attacks
    if (b.phase===1){
      // slow orbit + twin shots
      const a = Math.atan2(p.y-b.y,p.x-b.x);
      b.x = clamp(b.x + Math.cos(a)*90*dt, 24+b.r, s.w-24-b.r);
      b.y = clamp(b.y + Math.sin(a)*90*dt, 24+b.r, s.h-24-b.r);
      b.cd -= dt;
      if (b.cd<=0){
        const spread=0.18;
        for (let k=-1;k<=1;k+=2){
          const ang=a + k*spread;
          s.bullets.push({x:b.x,y:b.y,vx:Math.cos(ang)*420,vy:Math.sin(ang)*420,r:4,owner:'B',life:2.5});
        }
        b.cd = 0.55;
      }
    } else {
      // Phase 2: faster, triple spread + occasional dash
      if (b.tele>0){ b.tele-=dt; }
      else if (b.tele<=0 && rng(0,1)<0.006){ b.tele=0.9; b.dir = Math.atan2(p.y-b.y,p.x-b.x); } // telegraph start

      if (b.tele>0){
        // glow only, slight drift
        const a = Math.atan2(p.y-b.y,p.x-b.x);
        b.x = clamp(b.x + Math.cos(a)*60*dt, 24+b.r, s.w-24-b.r);
        b.y = clamp(b.y + Math.sin(a)*60*dt, 24+b.r, s.h-24-b.r);
      } else {
        // dash
        b.x = clamp(b.x + Math.cos(b.dir)*800*dt, 24+b.r, s.w-24-b.r);
        b.y = clamp(b.y + Math.sin(b.dir)*800*dt, 24+b.r, s.h-24-b.r);
      }

      b.cd -= dt;
      if (b.cd<=0){
        const a = Math.atan2(p.y-b.y,p.x-b.x);
        const spread=0.22;
        for (let i=-1;i<=1;i++){
          const ang=a + i*spread;
          s.bullets.push({x:b.x,y:b.y,vx:Math.cos(ang)*480,vy:Math.sin(ang)*480,r:4,owner:'B',life:2.3});
        }
        b.cd = 0.42;
      }
    }

    // hits (player bullets vs boss)
    for (const pr of s.bullets){
      if (pr.owner!=='p') continue;
      const d=(b.x-pr.x)*(b.x-pr.x) + (b.y-pr.y)*(b.y-pr.y);
      if (d <= (b.r+pr.r)*(b.r+pr.r)){
        b.hp -= 25; pr.life=0; addParticles(b.x,b.y,'#ff9b9b',16,2.2,140); beep(320,.05,'sine',.02);
        if (b.hp<=0){
          // boss defeated
          s.score += 10; s.kills += 5; // bonus
          s.p.hp = Math.min(100, s.p.hp + 35);
          if (s.p.shields < s.p.maxShields) s.p.shields++;
          s.boss=null; s.bossActive=false; s.nextBossIdx++; s.postBossCooldown=4; // calm window
          addParticles(b.x,b.y,'#ffd372',50,3,180);
          break;
        }
      }
    }

    // boss bullet hits player
    for (const pr of s.bullets){
      if (pr.owner!=='B') continue;
      const d=(s.p.x-pr.x)*(s.p.x-pr.x) + (s.p.y-pr.y)*(s.p.y-pr.y);
      if (d <= (s.p.r+pr.r)*(s.p.r+pr.r)){
        pr.life=0;
        if (s.p.invuln>0) continue;
        applyDamage(14); // slightly stronger than normal bot shot
      }
    }
  }

  // -------- Obstacles fade/regenerate --------
  function randomObstacles(){
    const MAX_W=220, MAX_H=140;
    const count = 4 + Math.floor(Math.random()*3); // 4..6
    const obs=[];
    for (let i=0;i<count;i++){
      const w = 60 + Math.random()*MAX_W;
      const h = 40 + Math.random()*Math.min(MAX_H, MAX_W);
      const x = clamp(rng(36, s.w-36-w), 24, s.w-24-w);
      const y = clamp(rng(36, s.h-36-h), 24, s.h-24-h);
      obs.push({x,y,w,h});
    }
    // keep a safe box around player
    const safe = {x:s.p.x-80,y:s.p.y-80,w:160,h:160};
    const bad = obs.some(o => !(safe.x+safe.w<o.x || safe.x>o.x+o.w || safe.y+safe.h<o.y || safe.y>o.y+o.h));
    return bad ? s.obstacles : obs;
  }
  function triggerObstacleSwap(){ s.obstaclePhase='fadeOut'; s.obstacleFadeT=0; }
  function updateObstacleFade(dt){
    if (s.obstaclePhase==='stable') return;
    const DUR=0.45; s.obstacleFadeT += dt; const t=clamp(s.obstacleFadeT/DUR,0,1);
    if (s.obstaclePhase==='fadeOut'){
      s.obstacleAlpha = 1 - t;
      if (s.obstacleFadeT>=DUR){ s.obstacles=randomObstacles(); s.obstaclePhase='fadeIn'; s.obstacleFadeT=0; }
    } else {
      s.obstacleAlpha = t;
      if (s.obstacleFadeT>=DUR){ s.obstaclePhase='stable'; s.obstacleAlpha=1; }
    }
  }

  // -------- Gameplay helpers --------
  function trySpawnMedkit(){
    // every 25 kills
    if (s.kills>0 && s.kills%25===0 && !s.medkits.some(m=>m.tag==='k'+s.kills)){
      for (let i=0;i<60;i++){
        const r=10, x=20+Math.random()*(s.w-40), y=20+Math.random()*(s.h-40);
        if (!posIsFree(x,y,r)) continue;
        s.medkits.push({x,y,r,life:20,tag:'k'+s.kills}); break;
      }
    }
  }
  function applyDamage(dmg){
    if (s.p.shields>0){
      const take = Math.min(dmg,25); dmg -= take;
      if (take>=25) s.p.shields--;
    }
    if (dmg>0){ s.p.hp -= dmg; s.p.invuln=0.25; addParticles(s.p.x,s.p.y,'#ff6666',10,2,140); beep(260,.06,'triangle',.03); }
  }

  // -------- Local leaderboard --------
  function loadTop10(){ try{ const raw=localStorage.getItem('mt_top10'); const arr=raw?JSON.parse(raw):[]; return Array.isArray(arr)?arr.slice(0,10):[]; }catch{ return [] } }
  function saveTop10(){ try{ localStorage.setItem('mt_top10', JSON.stringify(s.top10.slice(0,10))); }catch{} }
  function pushScore(name,score){ s.top10.push({name,score}); s.top10.sort((a,b)=>b.score-a.score); s.top10=s.top10.slice(0,10); saveTop10(); }
  function renderTop10(){
    uiTop10.innerHTML='';
    if (!s.top10.length){ const li=document.createElement('li'); li.innerHTML='<span>—</span><span>0</span>'; uiTop10.appendChild(li); uiAllTime.textContent=String(s.best||0); return; }
    uiAllTime.textContent=String(s.top10[0].score||0);
    s.top10.forEach((r,i)=>{ const li=document.createElement('li'); li.innerHTML = `<span>${String(i+1).padStart(2,'0')} · ${escapeHTML(r.name||'anon')}</span><span>${r.score}</span>`; uiTop10.appendChild(li); });
  }
  function escapeHTML(t){return String(t).replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]))}

  // -------- Name prompt --------
  let nameUI=null;
  function openNamePrompt(){
    if (nameUI) nameUI.remove();
    const b=document.createElement('div');
    b.style.position='fixed'; b.style.inset='0'; b.style.display='grid'; b.style.placeItems='center'; b.style.background='rgba(0,0,0,.55)';
    b.innerHTML=`
      <div style="background:var(--panel);border:1px solid var(--border);padding:16px;border-radius:14px;width:min(420px,90vw);box-shadow:var(--card)">
        <div style="font-weight:700;margin-bottom:8px">New Score: ${s.score}</div>
        <div class="muted" style="margin-bottom:6px">Enter your name for the local Top 10:</div>
        <input id="nm" type="text" maxlength="16" style="width:100%;padding:8px 10px;border-radius:10px;border:1px solid var(--border);background:var(--panel2);color:var(--text)" />
        <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px">
          <button id="skip" class="btn">Skip</button>
          <button id="save" class="btn">Save</button>
        </div>
      </div>`;
    document.body.appendChild(b); nameUI=b;
    const nm=b.querySelector('#nm'), sv=b.querySelector('#save'), sk=b.querySelector('#skip');
    nm.focus(); nm.addEventListener('keydown',e=>{ e.stopPropagation(); if(e.key==='Enter'){ doSave(); } });
    sv.addEventListener('click',e=>{ e.stopPropagation(); doSave(); });
    sk.addEventListener('click',e=>{ e.stopPropagation(); close(); });
    function doSave(){ pushScore(nm.value.trim()||'anon', s.score); renderTop10(); close(); }
    function close(){ if(nameUI){ nameUI.remove(); nameUI=null; } }
  }

  renderTop10();

  // -------- Main update/draw --------
  function update(dt){
    // UI mirrors
    uiScore.textContent=s.score; uiBest.textContent=s.best; uiBest2.textContent=s.best; uiLevel.textContent=s.level; uiMult.textContent='x1';
    hpFill.style.width = `${clamp(s.p.hp,0,100)}%`;
    shFill.style.width = `${clamp(s.p.shields*25,0,50)}%`;

    updateObstacleFade(dt);

    if (s.mode==='menu') return;
    if (s.mode==='countdown'){ s.countdown-=dt; if(s.countdown<=0) s.mode='playing'; return; }
    if (s.mode!=='playing') return;

    // boss scheduling
    if (!s.bossActive && s.nextBossIdx < s.bossSchedule.length && s.level === s.bossSchedule[s.nextBossIdx]){
      spawnBoss();
    }

    // post‑boss cooldown reduces pressure
    if (s.postBossCooldown>0) s.postBossCooldown -= dt;

    // spawn normal bots only if no boss & not in cooldown
    if (!s.bossActive && s.postBossCooldown<=0){
      s.spawnT -= dt;
      const base = Math.max(0.5, 1.6 - Math.min(60,s.score/5)*0.01);
      const scaled = Math.max(0.28, base * (1 - 0.06*(s.level-1)));
      if (s.spawnT<=0){ const eliteChance = Math.min(0.45, 0.04*s.level); spawnBot(Math.random()<eliteChance); s.spawnT=scaled; }
    }

    // progressive level (every 30 kills)
    const newLevel = Math.floor(s.kills/30)+1;
    if (newLevel> s.level){ s.level=newLevel; triggerObstacleSwap(); }

    // input/move
    const k=s.keys, p=s.p;
    let ix=0,iy=0; if(k['w']||k['arrowup'])iy--; if(k['s']||k['arrowdown'])iy++; if(k['a']||k['arrowleft'])ix--; if(k['d']||k['arrowright'])ix++;
    const mag=Math.hypot(ix,iy)||1, mvx=ix/mag*p.spd*dt, mvy=iy/mag*p.spd*dt;
    let nx=clamp(p.x+mvx,12+p.r,s.w-12-p.r); if(!s.obstacles.some(o=>rectCircleOverlap(nx,p.y,p.r,o))) p.x=nx;
    let ny=clamp(p.y+mvy,12+p.r,s.h-12-p.r); if(!s.obstacles.some(o=>rectCircleOverlap(p.x,ny,p.r,o))) p.y=ny;

    // shoot (hold)
    p.fireCD-=dt; p.flash=Math.max(0,p.flash-dt); p.invuln=Math.max(0,p.invuln-dt);
    if (s.mouse.down && p.fireCD<=0){
      const dx=s.mouse.x-p.x, dy=s.mouse.y-p.y, d=Math.hypot(dx,dy)||1;
      s.bullets.push({x:p.x,y:p.y,vx:dx/d*520,vy:dy/d*520,r:3,owner:'p',life:2});
      p.fireCD=0.15; p.flash=0.07; beep(1150,.045,'square',.03);
      addParticles(p.x+Math.cos(Math.atan2(dy,dx))*p.r, p.y+Math.sin(Math.atan2(dy,dx))*p.r, '#fff8', 5, 1.5, 90);
    }

    // bots AI
    s.bots.forEach(b=>{
      b.tw=(b.tw||0)+dt*2.2;
      const a=Math.atan2(p.y-b.y,p.x-b.x)+Math.sin(b.tw)*0.25;
      const sx=Math.cos(a)*b.spd*dt, sy=Math.sin(a)*b.spd*dt;
      let tx=b.x+sx; if(!s.obstacles.some(o=>rectCircleOverlap(tx,b.y,b.r,o))) b.x=clamp(tx,12+b.r,s.w-12-b.r);
      let ty=b.y+sy; if(!s.obstacles.some(o=>rectCircleOverlap(b.x,ty,b.r,o))) b.y=clamp(ty,12+b.r,s.h-12-b.r);
      b.cd-=dt; if(b.cd<=0){ const ang=Math.atan2(p.y-b.y,p.x-b.x)+(Math.random()-0.5)*0.18; s.bullets.push({x:b.x,y:b.y,vx:Math.cos(ang)*360,vy:Math.sin(ang)*360,r:3,owner:'b',life:2}); b.cd=(b.elite?0.7:0.9)*(0.95-0.03*(s.level-1)); }
    });

    // bullets move/cull
    s.bullets.forEach(b=>{ b.x+=b.vx*dt; b.y+=b.vy*dt; b.life-=dt; });
    s.bullets = s.bullets.filter(b => b.life>0 && b.x>-10 && b.x<s.w+10 && b.y>-10 && b.y<s.h+10 && !s.obstacles.some(o=>bulletHitsObstacle(b,o)) );

    // player hits bots
    s.bots = s.bots.filter(b=>{
      let alive=true;
      for(const pr of s.bullets){
        if (pr.owner!=='p') continue;
        const d=(b.x-pr.x)*(b.x-pr.x)+(b.y-pr.y)*(b.y-pr.y);
        if (d <= (b.r+pr.r)*(b.r+pr.r)){
          b.hp -= 25; pr.life=0; addParticles(b.x,b.y,b.elite?'#ffd372':'#ff7b72',12,2,140); beep(300,.05,'sine',.02);
          if (b.hp<=0){ alive=false; s.score += b.elite?2:1; s.kills++; trySpawnMedkit(); }
        }
      }
      return alive;
    });

    // bot bullets hit player
    for(const pr of s.bullets){
      if (pr.owner!=='b') continue;
      const d=(s.p.x-pr.x)*(s.p.x-pr.x)+(s.p.y-pr.y)*(s.p.y-pr.y);
      if (d <= (s.p.r+pr.r)*(s.p.r+pr.r)){ pr.life=0; if (s.p.invuln<=0) applyDamage(10); }
    }

    // boss update
    if (s.bossActive) updateBoss(dt);

    // medkits
    s.medkits.forEach(m=>m.life-=dt);
    s.medkits = s.medkits.filter(m=>{
      if (m.life<=0) return false;
      if (Math.hypot(m.x-s.p.x,m.y-s.p.y) < m.r + s.p.r){
        s.p.hp = Math.min(100, s.p.hp+30); addParticles(m.x,m.y,'#8cff8c',16,2.5,120); beep(900,.12,'triangle',.035);
        return false;
      }
      return true;
    });

    // death
    if (s.p.hp<=0){
      s.mode='gameover';
      try{ music.pause(); music.currentTime=0; }catch{}
      try{ if(!s.muted){ sting.currentTime=0; sting.play().catch(()=>{}); } }catch{}
      if (s.score > s.best){ s.best=s.score; try{ localStorage.setItem('mt_best', String(s.best)); }catch{} }
      requestAnimationFrame(()=>openNamePrompt());
    }
  }

  function draw(){
    // bg + safe filter
    ctx.save(); ctx.setTransform(1,0,0,1,0,0);
    try{ ctx.filter = s.retro ? 'grayscale(100%) contrast(115%) brightness(95%)' : 'none'; }catch{}
    ctx.fillStyle='#0b1320'; ctx.fillRect(0,0,s.w,s.h); ctx.restore();

    // frame
    ctx.strokeStyle='rgba(255,255,255,.18)'; ctx.strokeRect(12,12,s.w-24,s.h-24);

    const drawObsAlpha = s.obstacleAlpha;
    // obstacles
    ctx.save(); ctx.globalAlpha = drawObsAlpha;
    s.obstacles.forEach(o=>{
      ctx.fillStyle='#4b5563'; ctx.fillRect(o.x,o.y,o.w,o.h);
      ctx.strokeStyle='rgba(0,0,0,.25)'; ctx.strokeRect(o.x+0.5,o.y+0.5,o.w-1,o.h-1);
    });
    ctx.restore();

    // If MENU, keep map only (no entities behind overlay)
    const renderEntities = s.mode!=='menu';

    // medkits
    if (renderEntities){
      s.medkits.forEach(m=>{
        const blink = m.life<5 ? (Math.floor(m.life*10)%2===0) : true;
        if(!blink) return; const r=m.r;
        ctx.fillStyle='#e5f7ff'; ctx.fillRect(m.x-r,m.y-r,r*2,r*2);
        ctx.strokeStyle='#94a3b8'; ctx.strokeRect(m.x-r+0.5,m.y-r+0.5,r*2-1,r*2-1);
        ctx.fillStyle='#e11d48'; ctx.fillRect(m.x-r*0.25,m.y-r*0.8,r*0.5,r*1.6); ctx.fillRect(m.x-r*0.8,m.y-r*0.25,r*1.6,r*0.5);
      });
    }

    // player
    const p=s.p, ang=Math.atan2(s.mouse.y-p.y,s.mouse.x-p.x);
    if (renderEntities) drawSoldier(p.x,p.y,ang,p.r,p.flash,s.p.shields>0);

    // bots
    if (renderEntities){
      s.bots.forEach(b=>{
        ctx.fillStyle=b.elite?'#f0c420':'#ff7b72';
        ctx.beginPath(); ctx.arc(b.x,b.y,b.r,0,Math.PI*2); ctx.fill();
        const frac=Math.max(0,b.hp)/(b.elite?80:40);
        ctx.strokeStyle='rgba(255,255,255,.65)'; ctx.lineWidth=2;
        ctx.beginPath(); ctx.arc(b.x,b.y,b.r+4,-Math.PI/2,-Math.PI/2+frac*Math.PI*2); ctx.stroke();
      });
    }

    // boss
    if (s.bossActive && s.boss){
      const b=s.boss;
      // telegraph glow in phase 2 when tele>0
      if (b.phase===2 && b.tele>0){
        ctx.save(); ctx.shadowColor='rgba(255,80,80,.9)'; ctx.shadowBlur=20;
        ctx.fillStyle='#ef4444'; ctx.beginPath(); ctx.arc(b.x,b.y,b.r+2,0,Math.PI*2); ctx.fill(); ctx.restore();
      } else {
        ctx.fillStyle='#ef4444'; ctx.beginPath(); ctx.arc(b.x,b.y,b.r,0,Math.PI*2); ctx.fill();
      }
      // boss hp bar (top left mini)
      const w=160,h=8,x=20,y=24;
      ctx.fillStyle='rgba(255,255,255,.08)'; ctx.fillRect(x,y,w,h); ctx.fillStyle='#ff7a7a';
      const frac = clamp(b.hp/b.max,0,1); ctx.fillRect(x,y,w*frac,h);
      ctx.strokeStyle='rgba(255,255,255,.25)'; ctx.strokeRect(x+0.5,y+0.5,w-1,h-1);
    }

    // bullets
    if (renderEntities){
      s.bullets.forEach(b=>{ ctx.fillStyle=(b.owner==='p')?'#e6ff71':(b.owner==='B'?'#ff9b9b':'#ffa8a3'); ctx.beginPath(); ctx.arc(b.x,b.y,b.r,0,Math.PI*2); ctx.fill(); });
      s.particles.forEach(pt=>{ ctx.fillStyle=pt.c; ctx.beginPath(); ctx.arc(pt.x,pt.y,pt.sz,0,Math.PI*2); ctx.fill(); });
    }

    // overlays
    ctx.fillStyle='#fff'; ctx.textAlign='center';
    if (s.mode==='menu'){
      ctx.fillStyle='rgba(0,0,0,.55)'; ctx.fillRect(0,0,s.w,s.h);
      ctx.fillStyle='#fff'; ctx.font='bold 38px ui-sans-serif,system-ui'; ctx.fillText('MataTudo', s.w/2, s.h/2-40);
      ctx.font='16px ui-sans-serif,system-ui'; ctx.fillText('Press SPACE or Click to start', s.w/2, s.h/2);
      ctx.fillText(`Best: ${s.best}`, s.w/2, s.h/2+28);
    } else if (s.mode==='countdown'){
      ctx.fillStyle='rgba(0,0,0,.35)'; ctx.fillRect(0,0,s.w,s.h);
      ctx.fillStyle='#fff'; ctx.font='bold 48px ui-sans-serif,system-ui'; ctx.fillText(String(Math.max(1,Math.ceil(s.countdown))), s.w/2, s.h/2);
    } else if (s.mode==='gameover'){
      ctx.fillStyle='rgba(0,0,0,.65)'; ctx.fillRect(0,0,s.w,s.h);
      ctx.fillStyle='#fff'; ctx.font='bold 28px ui-sans-serif,system-ui'; ctx.fillText('Game Over', s.w/2, s.h/2-20);
      ctx.font='16px ui-sans-serif,system-ui'; ctx.fillText(`Score: ${s.score}   Best: ${s.best}`, s.w/2, s.h/2+10);
      ctx.fillText('Press R or SPACE (or click) to restart', s.w/2, s.h/2+36);
    }
    ctx.textAlign='start';
  }

  function drawSoldier(x,y,a,r,flash,hasShield){
    ctx.save(); ctx.translate(x,y); ctx.rotate(a);
    if (hasShield){ ctx.globalAlpha=.85; ctx.strokeStyle='rgba(120,200,255,.95)'; ctx.lineWidth=2.5; ctx.beginPath(); ctx.arc(0,0,r+5,0,Math.PI*2); ctx.stroke(); ctx.globalAlpha=1; }
    ctx.fillStyle='rgba(0,0,0,.25)'; ctx.beginPath(); ctx.ellipse(0,r*0.9,r*0.9,r*0.4,0,0,Math.PI*2); ctx.fill();
    const g=ctx.createRadialGradient(0,-r*0.2,r*0.2,0,0,r*1.05); g.addColorStop(0,'#34d27a'); g.addColorStop(1,'#228d4e');
    ctx.fillStyle=g; ctx.beginPath(); ctx.arc(0,0,r,0,Math.PI*2); ctx.fill();
    ctx.fillStyle='#1e824c'; ctx.beginPath(); ctx.arc(0,-r*0.3,r*0.95,Math.PI,0); ctx.fill();
    ctx.fillStyle='#145a32'; ctx.fillRect(-r,-r*0.3,r*2,r*0.15);
    ctx.fillStyle='#2ecc71'; ctx.fillRect(-r*1.2,-r*0.4,r*0.4,r*1.2); ctx.fillRect(r*0.8,-r*0.4,r*0.4,r*1.2);
    ctx.fillStyle='#dcdcdc'; ctx.fillRect(0,-3,r+14,6); ctx.fillStyle='#555'; ctx.fillRect(r+14,-2,4,4);
    if (flash>0){ ctx.fillStyle='rgba(255,240,120,.9)'; ctx.beginPath(); ctx.ellipse(r+20,0,7,3.5,0,0,Math.PI*2); ctx.fill(); }
    ctx.restore();
  }

  // -------- Spawns --------
  function spawnBot(elite=false){
    const r = elite?14:12; let x=0,y=0,tries=0;
    while(tries++<40){
      const edge=Math.floor(Math.random()*4);
      if(edge===0){x=12+r; y=Math.random()*s.h;}
      else if(edge===1){x=s.w-12-r; y=Math.random()*s.h;}
      else if(edge===2){x=Math.random()*s.w; y=12+r;}
      else {x=Math.random()*s.w; y=s.h-12-r;}
      if (posIsFree(x,y,r)) break;
    }
    const hp=elite?80:40; const spd=(elite?120:95);
    s.bots.push({x,y,r,hp,spd,cd:Math.random()*0.6+0.8,elite});
  }

  // -------- Loop --------
  function step(t){
    const dt = Math.min(0.033, (t-(s.last||t))/1000); s.last=t;
    update(dt); draw();
    requestAnimationFrame(step);
  }
  requestAnimationFrame(step);

  // start on first canvas click too
  cvs.addEventListener('click',()=>{ if(s.mode==='menu'){ startGame(); } });

  // music helpers
  function stopMusic(){ try{ music.pause(); music.currentTime=0; }catch{} }

})();
</script>
</body>
</html>
