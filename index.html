<!doctype html>
<html lang="en" data-theme="normal">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>MataTudo — Alpha 15.1</title>
<style>
  /* ---------- THEME (instant UI dark/retro toggle) ---------- */
  :root{
    --bg: #0b1220;
    --panel: #0c1528;
    --panel-2: #0b1220;
    --text: #e8f0ff;
    --muted: #9fb3d6;
    --accent: #60a5fa;
    --ok: #34d27a;
    --warn: #fbbf24;
    --danger:#ef4444;
    --border: rgba(255,255,255,.08);
    --shadow: rgba(0,0,0,.35);
    --card-shadow: 0 10px 30px rgba(0,0,0,.35);
  }
  [data-theme="retro"]{
    --bg: #0a0a0a;
    --panel: #0f0f0f;
    --panel-2: #0b0b0b;
    --text: #ededed;
    --muted:#c8c8c8;
    --accent:#9ad1ff;
    --ok:#a8e6b8;
    --warn:#ffd470;
    --danger:#ff7a7a;
    --border: rgba(255,255,255,.12);
    --shadow: rgba(0,0,0,.55);
    --card-shadow: 0 12px 36px rgba(0,0,0,.55);
  }

  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; background:var(--bg); color:var(--text);
    font:14px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  }
  .wrap{
    max-width: 1280px; margin: 28px auto; padding: 0 16px;
    display:grid; grid-template-columns: 280px 1fr 300px; gap:20px;
  }
  h1{margin:0 auto 10px auto; text-align:center; font-weight:700; letter-spacing:.3px}
  .panel{
    background:var(--panel); border:1px solid var(--border);
    border-radius:14px; box-shadow:var(--card-shadow); padding:12px 12px;
  }
  .panel h2{
    margin:4px 0 10px; font-size:13px; letter-spacing:.3px; opacity:.9
  }
  .kv{display:flex; justify-content:space-between; gap:10px; padding:2px 0}
  .muted{color:var(--muted)}
  .btn{
    display:inline-block; padding:6px 10px; border-radius:10px;
    border:1px solid var(--border); background:transparent; color:var(--text);
    cursor:pointer;
  }
  .btn:active{transform:translateY(1px)}
  .range{width:100%}
  .hpbar, .shieldbar{
    width:100%; height:8px; background:rgba(255,255,255,.06);
    border-radius:6px; border:1px solid var(--border); position:relative; overflow:hidden;
  }
  .hpbar .fill{position:absolute; left:0; top:0; bottom:0; background:var(--ok)}
  .shieldbar{ height:6px; margin-top:6px }
  .shieldbar .fill{position:absolute; left:0; top:0; bottom:0; background:#7cc7ff}
  .tips{font-size:12px; line-height:1.3; white-space:pre-line; opacity:.9}
  .card{background:var(--panel-2); border:1px solid var(--border); border-radius:12px; padding:10px; margin-top:10px}
  .canvasWrap{
    background: #000; border:1px solid var(--border); border-radius:18px; box-shadow:var(--card-shadow);
    padding:8px;
  }
  canvas{display:block; margin:auto; background:#000; border-radius:12px}
  .footer{margin:10px auto 0; text-align:center; font-size:12px; color:var(--muted)}
  .row{display:flex; align-items:center; gap:8px}
  .right .leaderboard{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:12px}
  .lb-list{margin:8px 0 0; padding:0; list-style:none}
  .lb-list li{display:flex; justify-content:space-between; padding:3px 0; border-bottom:1px dotted var(--border)}
  .toggle-row{display:flex; align-items:center; justify-content:space-between; gap:8px}
</style>
</head>
<body>
  <h1>MataTudo — Alpha 15.1</h1>
  <div class="wrap">
    <!-- LEFT PANEL -->
    <div class="panel left">
      <div class="kv"><div>Score</div><div id="uiScore">0</div></div>
      <div class="kv"><div>Best</div><div id="uiBest">0</div></div>
      <div class="kv"><div>Level</div><div id="uiLevel">1</div></div>
      <div class="kv"><div>Mult</div><div id="uiMult">x1</div></div>
      <div class="kv"><div>Power</div><div id="uiPower">-</div></div>

      <div class="card">
        <div class="muted" style="font-size:12px; margin-bottom:3px">HP</div>
        <div class="hpbar"><div id="hpFill" class="fill" style="width:100%"></div></div>
        <div class="shieldbar"><div id="shFill" class="fill" style="width:0%"></div></div>
      </div>

      <div class="card">
        <div class="tips">Tips
• WASD / Arrows move
• Mouse aims • Click shoots (hold)
• M mute • R restart
• SPACE starts
• Level +1 every 30 kills
• Boss at 5,15,25,40,55,75…</div>
      </div>

      <div class="card">
        <div class="row">
          <button id="btnMute" class="btn">Mute</button>
          <div class="row" style="flex:1">
            <span class="muted">Vol</span>
            <input id="rngVol" class="range" type="range" min="0" max="1" step="0.05" value="0.7" />
          </div>
        </div>
      </div>

      <div class="card">
        <button id="btnPause" class="btn" style="width:100%">Pause</button>
      </div>
    </div>

    <!-- CENTER: CANVAS -->
    <div class="canvasWrap">
      <canvas id="game" width="980" height="560"></canvas>
      <div class="footer">Press <b>SPACE</b> to start • Retro toggle in right panel • Destructibles & drops coming in A15.x</div>
    </div>

    <!-- RIGHT PANEL -->
    <div class="panel right">
      <h2>Global &amp; Missions</h2>

      <div class="card leaderboard">
        <div class="kv"><strong>Leaderboards</strong><span class="muted">Local</span></div>
        <div class="kv"><span>All‑Time (Local)</span><span id="uiAllTime">0</span></div>
        <div class="kv"><span>Your Best</span><span id="uiBest2">0</span></div>
        <div class="muted" style="margin-top:6px">Top 10</div>
        <ul id="uiTop10" class="lb-list">
          <!-- populated at runtime -->
        </ul>
      </div>

      <div class="card">
        <div class="toggle-row">
          <div>
            <div><strong>Retro Mode</strong></div>
            <div class="muted" style="font-size:12px">Grayscale + scanlines vibe</div>
          </div>
          <label class="row">
            <input id="retroToggle" type="checkbox" />
            <span class="muted">On</span>
          </label>
        </div>
      </div>
    </div>
  </div>

<script>
(() => {
  const cvs = document.getElementById('game');
  const ctx = cvs.getContext('2d', { alpha:false });

  // ---------- Authoritative state ----------
  const s = {
    mode: 'menu', // 'menu' | 'countdown' | 'playing' | 'gameover'
    last: 0,
    countdown: 2,
    width: cvs.width, height: cvs.height,
    retro: false, // UI + canvas vibe
    // player
    p: { x: cvs.width/2, y: cvs.height/2, r: 12, hp:100, shields:0, maxShields:2, spd:240, fireCD:0, flash:0, invuln:0 },
    // input
    keys: Object.create(null),
    mouse: { x:cvs.width/2, y:cvs.height/2, down:false },
    // world
    bullets: [], bots: [], particles: [], medkits: [], obstacles: genInitialObstacles(),
    spawnT: 0, score: 0, best: 0, level: 1, kills: 0,
    // audio (simple)
    muted:false, volume:0.7,
    // leaderboard
    top10: loadTop10(),
    // theme persistence
    themeKey: 'mt_visual_mode'
  };

  // restore best + theme
  try { s.best = parseInt(localStorage.getItem('mt_best')||'0',10)||0; } catch {}
  try {
    const saved = localStorage.getItem(s.themeKey);
    s.retro = saved === 'retro';
  } catch {}
  document.documentElement.setAttribute('data-theme', s.retro ? 'retro' : 'normal');
  document.getElementById('retroToggle').checked = s.retro;

  // ---------- UI elements ----------
  const uiScore = document.getElementById('uiScore');
  const uiBest = document.getElementById('uiBest');
  const uiBest2 = document.getElementById('uiBest2');
  const uiLevel = document.getElementById('uiLevel');
  const uiMult = document.getElementById('uiMult');
  const hpFill = document.getElementById('hpFill');
  const shFill = document.getElementById('shFill');
  const btnPause = document.getElementById('btnPause');
  const btnMute = document.getElementById('btnMute');
  const rngVol = document.getElementById('rngVol');
  const retroToggle = document.getElementById('retroToggle');
  const uiAllTime = document.getElementById('uiAllTime');
  const uiTop10 = document.getElementById('uiTop10');

  // ---------- Helpers ----------
  const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
  function genInitialObstacles(){
    return [
      {x:280,y:180,w:90,h:90},
      {x:610,y:340,w:120,h:70},
      {x:440,y: 90,w:70,h:70},
      {x:120,y:400,w:140,h:40},
    ];
  }
  function rectCircleOverlap(cx,cy,r,o){
    const nx = clamp(cx, o.x, o.x+o.w), ny = clamp(cy, o.y, o.y+o.h);
    const dx=cx-nx, dy=cy-ny; return dx*dx+dy*dy <= r*r;
  }
  function bulletHitsObstacle(b,o){
    return (b.x+b.r>o.x && b.x-b.r<o.x+o.w && b.y+b.r>o.y && b.y-b.r<o.y+o.h);
  }
  function posIsFree(x,y,r){
    if (x<12+r || x>cvs.width-12-r || y<12+r || y>cvs.height-12-r) return false;
    if (s.obstacles.some(o=>rectCircleOverlap(x,y,r,o))) return false;
    return true;
  }
  function addParticles(x,y,col,count=12,size=2,spd=120){
    for (let i=0;i<count;i++){
      const a=Math.random()*Math.PI*2, v=spd*(.5+Math.random());
      s.particles.push({x,y,vx:Math.cos(a)*v,vy:Math.sin(a)*v,life:.5+.4*Math.random(),c:col,sz:size});
    }
  }
  function loadTop10(){
    try{
      const raw = localStorage.getItem('mt_top10');
      if (!raw) return [];
      const arr = JSON.parse(raw); return Array.isArray(arr)?arr.slice(0,10):[];
    }catch{return []}
  }
  function saveTop10(){
    try{ localStorage.setItem('mt_top10', JSON.stringify(s.top10.slice(0,10))); }catch{}
  }
  function pushScore(name, score){
    s.top10.push({name,score});
    s.top10.sort((a,b)=>b.score-a.score);
    s.top10 = s.top10.slice(0,10);
    saveTop10();
  }
  function renderTop10(){
    uiTop10.innerHTML = '';
    if (!s.top10.length){
      const li=document.createElement('li'); li.innerHTML='<span>—</span><span>0</span>'; uiTop10.appendChild(li);
      uiAllTime.textContent = String(s.best||0);
      return;
    }
    uiAllTime.textContent = String(s.top10[0].score||0);
    s.top10.forEach((row,i)=>{
      const li=document.createElement('li');
      li.innerHTML = `<span>${String(i+1).padStart(2,'0')} · ${escapeHTML(row.name||'anon')}</span><span>${row.score}</span>`;
      uiTop10.appendChild(li);
    });
  }
  function escapeHTML(s){ return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

  // ---------- Audio (ultra‑light SFX) ----------
  let ac=null, master=null; function ensureAC(){ if(ac) return; const C=window.AudioContext||window.webkitAudioContext; if(!C) return; ac=new C(); master=ac.createGain(); master.gain.value=s.muted?0:s.volume; master.connect(ac.destination); }
  function beep(freq=900,dur=.06,type='square',gain=.03){ if(s.muted) return; ensureAC(); if(!ac) return; const o=ac.createOscillator(), g=ac.createGain(); o.type=type; o.frequency.value=freq; g.gain.value=gain; o.connect(g).connect(master); const t=ac.currentTime; g.gain.setValueAtTime(gain,t); g.gain.exponentialRampToValueAtTime(0.0001,t+dur); o.start(t); o.stop(t+dur); }

  // ---------- UI Wiring ----------
  btnPause.addEventListener('click', ()=>{ s.mode = (s.mode==='playing'?'menu':'playing'); });
  btnMute.addEventListener('click', ()=>{ s.muted=!s.muted; if(master) master.gain.value = s.muted?0:s.volume; btnMute.textContent = s.muted?'Unmute':'Mute'; });
  rngVol.addEventListener('input', ()=>{ s.volume=parseFloat(rngVol.value); if(master && !s.muted) master.gain.value=s.volume; });

  retroToggle.addEventListener('change', ()=>{
    s.retro = retroToggle.checked;
    try{ localStorage.setItem(s.themeKey, s.retro?'retro':'normal'); }catch{}
    document.documentElement.setAttribute('data-theme', s.retro ? 'retro' : 'normal');
  });

  function isEditing(){
    const el = document.activeElement;
    return el && (el.tagName==='INPUT' || el.tagName==='TEXTAREA' || el.isContentEditable);
  }

  // Keyboard
  window.addEventListener('keydown', (e)=>{
    const k = e.key.toLowerCase();
    // allow SPACE/R even when focused on inputs (start/restart)
    if (isEditing()){
      if (e.code==='Space'){ if (s.mode==='menu' || s.mode==='gameover'){ e.preventDefault(); startGame(); } return; }
      if (k==='r'){ if (s.mode==='gameover'){ e.preventDefault(); startGame(); } return; }
      // others ignored while editing
      return;
    }
    if (!e.repeat) s.keys[k]=true;
    if (k==='m'){ s.muted=!s.muted; if(master) master.gain.value=s.muted?0:s.volume; btnMute.textContent=s.muted?'Unmute':'Mute'; }
    if (s.mode==='menu' && e.code==='Space'){ startGame(); }
    if (s.mode==='gameover' && (k==='r' || e.code==='Space')){ startGame(); }
  });
  window.addEventListener('keyup', (e)=>{ s.keys[e.key.toLowerCase()]=false; });

  // Mouse
  function toLocal(e){
    const r=cvs.getBoundingClientRect();
    s.mouse.x = (e.clientX - r.left) * (cvs.width / r.width);
    s.mouse.y = (e.clientY - r.top) * (cvs.height / r.height);
  }
  cvs.addEventListener('mousemove', (e)=>{ toLocal(e); });
  cvs.addEventListener('mousedown', (e)=>{ toLocal(e); s.mouse.down=true; if (s.mode==='menu'){ startGame(); return; } });
  window.addEventListener('mouseup', ()=>{ s.mouse.down=false; });

  // ---------- Game core ----------
  function startGame(){
    ensureAC();
    s.mode='countdown'; s.countdown=2;
    s.p = { x:cvs.width/2, y:cvs.height/2, r:12, hp:100, shields:0, maxShields:2, spd:240, fireCD:0, flash:0, invuln:0 };
    s.bullets.length=0; s.bots.length=0; s.particles.length=0; s.medkits.length=0;
    s.obstacles = genInitialObstacles();
    s.spawnT=0; s.score=0; s.level=1; s.kills=0;
  }

  function spawnBot(elite=false){
    const r = elite?14:12;
    let x=0,y=0,tries=0;
    while (tries++<40){
      const edge=Math.floor(Math.random()*4);
      if(edge===0){x=12+r; y=Math.random()*cvs.height;}
      else if(edge===1){x=cvs.width-12-r; y=Math.random()*cvs.height;}
      else if(edge===2){x=Math.random()*cvs.width; y=12+r;}
      else {x=Math.random()*cvs.width; y=cvs.height-12-r;}
      if (posIsFree(x,y,r)) break;
    }
    const hp = elite?80:40;
    s.bots.push({x,y,r,hp,spd:(elite?120:95), cd:Math.random()*0.6+0.7, elite});
  }

  function trySpawnMedkit(){
    // every 25 kills
    if (s.kills>0 && s.kills%25===0 && !s.medkits.some(m=>m.tag==='k'+s.kills)){
      for (let i=0;i<60;i++){
        const r=10, x=20+Math.random()*(cvs.width-40), y=20+Math.random()*(cvs.height-40);
        if (!posIsFree(x,y,r)) continue;
        s.medkits.push({x,y,r,life:20, tag:'k'+s.kills});
        break;
      }
    }
  }

  function update(dt){
    // UI mirrors
    uiScore.textContent = s.score;
    uiBest.textContent  = s.best;
    uiBest2.textContent = s.best;
    uiLevel.textContent = s.level;
    uiMult.textContent  = 'x1';
    hpFill.style.width = `${clamp(s.p.hp,0,100)}%`;
    shFill.style.width = `${clamp(s.p.shields*25,0,50)}%`; // 25 hp per shield, max 2 => 50%

    if (s.mode==='menu') return;
    if (s.mode==='countdown'){ s.countdown -= dt; if (s.countdown<=0) s.mode='playing'; return; }
    if (s.mode!=='playing') return;

    // spawn pacing
    s.spawnT -= dt;
    if (s.spawnT<=0){ spawnBot(Math.random()<Math.min(.25,(s.level-1)*.02)); s.spawnT = Math.max(.35, 1.4 - s.level*0.06); }

    // input move
    const k=s.keys, p=s.p;
    let ix=0,iy=0; if(k['w']||k['arrowup'])iy--; if(k['s']||k['arrowdown'])iy++; if(k['a']||k['arrowleft'])ix--; if(k['d']||k['arrowright'])ix++;
    const mag=Math.hypot(ix,iy)||1, mvx=ix/mag*p.spd*dt, mvy=iy/mag*p.spd*dt;
    let nx=clamp(p.x+mvx, 12+p.r, cvs.width-12-p.r); if(!s.obstacles.some(o=>rectCircleOverlap(nx,p.y,p.r,o))) p.x=nx;
    let ny=clamp(p.y+mvy, 12+p.r, cvs.height-12-p.r); if(!s.obstacles.some(o=>rectCircleOverlap(p.x,ny,p.r,o))) p.y=ny;

    // continuous fire while holding mouse
    p.fireCD -= dt; p.flash=Math.max(0,p.flash-dt); p.invuln=Math.max(0,p.invuln-dt);
    if (s.mouse.down && p.fireCD<=0){
      const dx=s.mouse.x-p.x, dy=s.mouse.y-p.y, d=Math.hypot(dx,dy)||1;
      s.bullets.push({x:p.x,y:p.y,vx:dx/d*520,vy:dy/d*520,r:3,owner:'p',life:2});
      p.fireCD=0.15; p.flash=0.07; beep(1150,.045,'square',.03);
      addParticles(p.x+Math.cos(Math.atan2(dy,dx))*p.r, p.y+Math.sin(Math.atan2(dy,dx))*p.r, '#fff8', 5, 1.5, 90);
    }

    // bots move & shoot
    s.bots.forEach(b=>{
      const a=Math.atan2(p.y-b.y,p.x-b.x) + Math.sin((b.tw=(b.tw||0)+dt*2))*0.25;
      const stepX=Math.cos(a)*b.spd*dt, stepY=Math.sin(a)*b.spd*dt;
      let tx=b.x+stepX; if(!s.obstacles.some(o=>rectCircleOverlap(tx,b.y,b.r,o))) b.x=clamp(tx,12+b.r,cvs.width-12-b.r);
      let ty=b.y+stepY; if(!s.obstacles.some(o=>rectCircleOverlap(b.x,ty,b.r,o))) b.y=clamp(ty,12+b.r,cvs.height-12-b.r);
      b.cd -= dt;
      if (b.cd<=0){
        const ang=Math.atan2(p.y-b.y,p.x-b.x)+(Math.random()-0.5)*0.18;
        s.bullets.push({x:b.x,y:b.y,vx:Math.cos(ang)*360,vy:Math.sin(ang)*360,r:3,owner:'b',life:2});
        b.cd = (b.elite?0.7:0.9)*(0.95-0.03*(s.level-1));
      }
    });

    // bullets move
    s.bullets.forEach(b=>{ b.x+=b.vx*dt; b.y+=b.vy*dt; b.life-=dt; });
    s.bullets = s.bullets.filter(b => b.life>0 && b.x>-10 && b.x<cvs.width+10 && b.y>-10 && b.y<cvs.height+10 && !s.obstacles.some(o=>bulletHitsObstacle(b,o)) );

    // hits: player bullet -> bot
    s.bots = s.bots.filter(b=>{
      let alive=true;
      for (const pr of s.bullets){
        if (pr.owner!=='p') continue;
        const d=(b.x-pr.x)*(b.x-pr.x)+(b.y-pr.y)*(b.y-pr.y);
        if (d <= (b.r+pr.r)*(b.r+pr.r)){
          b.hp -= 25; pr.life=0; addParticles(b.x,b.y,b.elite?'#ffd372':'#ff7b72',12,2,140); beep(300,.05,'sine',.02);
          if (b.hp<=0){ alive=false; s.score += b.elite?2:1; s.kills++; trySpawnMedkit(); break; }
        }
      }
      return alive;
    });

    // hits: bot bullet -> player
    for (const pr of s.bullets){
      if (pr.owner!=='b') continue;
      const d=(s.p.x-pr.x)*(s.p.x-pr.x)+(s.p.y-pr.y)*(s.p.y-pr.y);
      if (d <= (s.p.r+pr.r)*(s.p.r+pr.r)){
        pr.life=0;
        if (s.p.invuln>0) continue;
        let dmg=10;
        if (s.p.shields>0){
          const take=Math.min(dmg,25); // 25 per shield pip
          dmg -= take;
          // consume shield proportionally
          const pips=Math.ceil((25-take)/25);
          if (take>=25){ s.p.shields-=1; }
        }
        if (dmg>0){ s.p.hp -= dmg; s.p.invuln=0.25; addParticles(s.p.x,s.p.y,'#ff6666',10,2,140); beep(260,.06,'triangle',.03); }
      }
    }

    // medkits
    s.medkits.forEach(m=>m.life-=dt);
    s.medkits = s.medkits.filter(m=>{
      if (m.life<=0) return false;
      if (Math.hypot(m.x-s.p.x,m.y-s.p.y) < m.r + s.p.r){
        s.p.hp = Math.min(100, s.p.hp+30);
        addParticles(m.x,m.y,'#8cff8c',16,2.5,120); beep(900,.12,'triangle',.035);
        return false;
      }
      return true;
    });

    // level up every 30 kills (simple)
    const newLevel = Math.floor(s.kills/30)+1;
    if (newLevel> s.level){ s.level=newLevel; }

    // +1 shield every 30 kills (max 2)
    const shieldSlots = Math.min(2, Math.floor(s.kills/30));
    s.p.shields = Math.min(s.p.shields + (shieldSlots - s.p.shields), 2);

    // death
    if (s.p.hp<=0){
      s.mode='gameover';
      if (s.score > s.best){ s.best = s.score; try{ localStorage.setItem('mt_best', String(s.best)); }catch{} }
      // prompt name & push into top10 (non-blocking, avoid focus issues)
      requestAnimationFrame(()=> openNamePrompt());
    }
  }

  function draw(){
    // background
    ctx.save();
    ctx.setTransform(1,0,0,1,0,0);
    // Safe filter (prevents black-screen on unsupported canvases)
    try { ctx.filter = s.retro ? 'grayscale(100%) contrast(115%) brightness(95%)' : 'none'; } catch {}
    ctx.fillStyle = '#0b1320'; ctx.fillRect(0,0,cvs.width,cvs.height);
    ctx.restore();

    // border
    ctx.strokeStyle='rgba(255,255,255,.18)'; ctx.strokeRect(12,12,cvs.width-24,cvs.height-24);

    // obstacles
    s.obstacles.forEach(o=>{
      ctx.fillStyle='#4b5563'; ctx.fillRect(o.x,o.y,o.w,o.h);
      ctx.strokeStyle='rgba(0,0,0,.25)'; ctx.strokeRect(o.x+0.5,o.y+0.5,o.w-1,o.h-1);
    });

    // medkits
    s.medkits.forEach(m=>{
      const blink = m.life<5 ? (Math.floor(m.life*10)%2===0) : true;
      if(!blink) return;
      const r=m.r;
      ctx.fillStyle='#e5f7ff'; ctx.fillRect(m.x-r,m.y-r,r*2,r*2);
      ctx.strokeStyle='#94a3b8'; ctx.strokeRect(m.x-r+0.5,m.y-r+0.5,r*2-1,r*2-1);
      ctx.fillStyle='#e11d48';
      ctx.fillRect(m.x-r*0.25,m.y-r*0.8,r*0.5,r*1.6);
      ctx.fillRect(m.x-r*0.8,m.y-r*0.25,r*1.6,r*0.5);
    });

    // player
    const p=s.p, ang=Math.atan2(s.mouse.y-p.y,s.mouse.x-p.x);
    drawSoldier(p.x,p.y,ang,p.r,p.flash,s.p.shields>0);

    // bots
    s.bots.forEach(b=>{
      ctx.fillStyle=b.elite?'#f0c420':'#ff7b72';
      ctx.beginPath(); ctx.arc(b.x,b.y,b.r,0,Math.PI*2); ctx.fill();
      // hp ring
      const frac=Math.max(0,b.hp)/(b.elite?80:40);
      ctx.strokeStyle='rgba(255,255,255,.65)'; ctx.lineWidth=2;
      ctx.beginPath(); ctx.arc(b.x,b.y,b.r+4,-Math.PI/2,-Math.PI/2+frac*Math.PI*2); ctx.stroke();
    });

    // bullets
    s.bullets.forEach(b=>{
      ctx.fillStyle=b.owner==='p'?'#e6ff71':'#ffa8a3';
      ctx.beginPath(); ctx.arc(b.x,b.y,b.r,0,Math.PI*2); ctx.fill();
    });

    // particles
    s.particles.forEach(pt=>{ ctx.fillStyle=pt.c; ctx.beginPath(); ctx.arc(pt.x,pt.y,pt.sz,0,Math.PI*2); ctx.fill(); });

    // overlays
    ctx.fillStyle='#fff'; ctx.textAlign='center';
    if (s.mode==='menu'){
      ctx.fillStyle='rgba(0,0,0,.55)'; ctx.fillRect(0,0,cvs.width,cvs.height);
      ctx.fillStyle='#fff'; ctx.font='bold 38px ui-sans-serif,system-ui'; ctx.fillText('MataTudo', cvs.width/2, cvs.height/2-40);
      ctx.font='16px ui-sans-serif,system-ui'; ctx.fillText('Press SPACE or Click to start', cvs.width/2, cvs.height/2);
      ctx.fillText(`Best: ${s.best}`, cvs.width/2, cvs.height/2+28);
    } else if (s.mode==='countdown'){
      ctx.fillStyle='rgba(0,0,0,.35)'; ctx.fillRect(0,0,cvs.width,cvs.height);
      ctx.fillStyle='#fff'; ctx.font='bold 48px ui-sans-serif,system-ui'; ctx.fillText(String(Math.max(1,Math.ceil(s.countdown))), cvs.width/2, cvs.height/2);
    } else if (s.mode==='gameover'){
      ctx.fillStyle='rgba(0,0,0,.65)'; ctx.fillRect(0,0,cvs.width,cvs.height);
      ctx.fillStyle='#fff'; ctx.font='bold 28px ui-sans-serif,system-ui'; ctx.fillText('Game Over', cvs.width/2, cvs.height/2-20);
      ctx.font='16px ui-sans-serif,system-ui'; ctx.fillText(`Score: ${s.score}   Best: ${s.best}`, cvs.width/2, cvs.height/2+10);
      ctx.fillText('Press R or SPACE (or click) to restart', cvs.width/2, cvs.height/2+36);
    }
    ctx.textAlign='start';
  }

  function drawSoldier(x,y,a,r,flash,hasShield){
    ctx.save(); ctx.translate(x,y); ctx.rotate(a);
    // shield glow ring
    if (hasShield){
      ctx.globalAlpha = 0.8;
      ctx.strokeStyle='rgba(120,200,255,.9)'; ctx.lineWidth=2.5;
      ctx.beginPath(); ctx.arc(0,0,r+5,0,Math.PI*2); ctx.stroke();
      ctx.globalAlpha = 1;
    }
    // shadow
    ctx.fillStyle='rgba(0,0,0,.25)'; ctx.beginPath(); ctx.ellipse(0,r*0.9,r*0.9,r*0.4,0,0,Math.PI*2); ctx.fill();
    // body
    const g=ctx.createRadialGradient(0,-r*0.2,r*0.2,0,0,r*1.05); g.addColorStop(0,'#34d27a'); g.addColorStop(1,'#228d4e');
    ctx.fillStyle=g; ctx.beginPath(); ctx.arc(0,0,r,0,Math.PI*2); ctx.fill();
    // helmet + visor
    ctx.fillStyle='#1e824c'; ctx.beginPath(); ctx.arc(0,-r*0.3,r*0.95,Math.PI,0); ctx.fill();
    ctx.fillStyle='#145a32'; ctx.fillRect(-r,-r*0.3,r*2,r*0.15);
    ctx.fillStyle='#c8f6ff'; ctx.fillRect(-r*0.4,-r*0.2,r*0.8,r*0.25);
    // arms
    ctx.fillStyle='#2ecc71'; ctx.fillRect(-r*1.2,-r*0.4,r*0.4,r*1.2); ctx.fillRect(r*0.8,-r*0.4,r*0.4,r*1.2);
    // gun
    ctx.fillStyle='#dcdcdc'; ctx.fillRect(0,-3,r+14,6);
    ctx.fillStyle='#555'; ctx.fillRect(r+14,-2,4,4);
    // muzzle
    if (flash>0){ ctx.fillStyle='rgba(255,240,120,.9)'; ctx.beginPath(); ctx.ellipse(r+20,0,7,3.5,0,0,Math.PI*2); ctx.fill(); }
    ctx.restore();
  }

  // ---------- Game Over name prompt (local top‑10) ----------
  let nameUI=null;
  function openNamePrompt(){
    if (nameUI){ nameUI.remove(); nameUI=null; }
    const b = document.createElement('div');
    b.style.position='fixed'; b.style.inset='0'; b.style.display='grid';
    b.style.placeItems='center'; b.style.background='rgba(0,0,0,.55)';
    b.innerHTML = `
      <div style="background:var(--panel); border:1px solid var(--border); padding:16px; border-radius:14px; width: min(420px,90vw); box-shadow: var(--card-shadow)">
        <div style="font-weight:700; margin-bottom:10px">New Score: ${s.score}</div>
        <div class="muted" style="margin-bottom:6px">Enter your name for the local Top 10:</div>
        <input id="nm" type="text" maxlength="16" style="width:100%; padding:8px 10px; border-radius:10px; border:1px solid var(--border); background:var(--panel-2); color:var(--text)" />
        <div style="display:flex; justify-content:flex-end; gap:8px; margin-top:12px">
          <button id="skip" class="btn">Skip</button>
          <button id="save" class="btn">Save</button>
        </div>
      </div>`;
    document.body.appendChild(b);
    nameUI=b;
    const nm=b.querySelector('#nm'); const save=b.querySelector('#save'); const skip=b.querySelector('#skip');
    // Important: prevent the overlay from closing on first click
    nm.focus(); nm.addEventListener('keydown', (e)=>{ e.stopPropagation(); if (e.key==='Enter'){ doSave(); } });
    save.addEventListener('click', (e)=>{ e.stopPropagation(); doSave(); });
    skip.addEventListener('click', (e)=>{ e.stopPropagation(); close(); });

    function doSave(){
      const name = nm.value.trim() || 'anon';
      pushScore(name, s.score);
      renderTop10();
      close();
    }
    function close(){ if (nameUI){ nameUI.remove(); nameUI=null; } }
  }

  renderTop10();

  // ---------- Main loop ----------
  function step(t){
    const dt = Math.min(0.033, (t-(s.last||t))/1000); s.last=t;
    update(dt); draw();
    requestAnimationFrame(step);
  }
  requestAnimationFrame(step);

  // start on first click too (even if inputs focused)
  cvs.addEventListener('click', ()=>{
    if (s.mode==='menu'){ startGame(); }
  });

})();
</script>
</body>
</html>
