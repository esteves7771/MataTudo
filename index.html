<!doctype html>
<html lang="en" data-theme="normal">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>MataTudo — Alpha 15.2 (rebased on 14.2)</title>
<style>
  :root{
    --bg:#0b1220; --panel:#0c1528; --panel2:#0b1220; --text:#e9f1ff;
    --muted:#9fb3d6; --border:rgba(255,255,255,.1); --card:0 10px 30px rgba(0,0,0,.35);
    --ok:#34d27a; --accent:#60a5fa;
  }
  [data-theme="retro"]{
    --bg:#0b0b0b; --panel:#111; --panel2:#0d0d0d; --text:#ededed; --muted:#bfbfbf;
    --border:rgba(255,255,255,.12); --card:0 12px 36px rgba(0,0,0,.55);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--text);font:14px ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Arial}
  h1{margin:18px 0 10px;text-align:center;font-weight:800}
  .wrap{
    max-width:1600px;margin:0 auto;padding:0 16px 22px;
    display:grid;grid-template-columns:280px minmax(980px,980px) 300px;gap:18px;justify-content:center
  }
  .panel{width:100%;background:var(--panel);border:1px solid var(--border);border-radius:14px;box-shadow:var(--card);padding:12px}
  .kv{display:flex;justify-content:space-between;padding:2px 0}
  .card{background:var(--panel2);border:1px solid var(--border);border-radius:12px;padding:10px;margin-top:10px}
  .muted{color:var(--muted)}
  .btn{padding:6px 10px;border:1px solid var(--border);border-radius:10px;background:transparent;color:var(--text);cursor:pointer}
  .btn:active{transform:translateY(1px)}
  .row{display:flex;align-items:center;gap:8px}
  .range{width:100%}
  .hpbar{height:8px;width:100%;background:rgba(255,255,255,.06);border:1px solid var(--border);border-radius:6px;position:relative;overflow:hidden}
  .hpbar>.fill{position:absolute;left:0;top:0;bottom:0;background:var(--ok)}
  .shieldbar{height:6px;margin-top:6px;background:rgba(255,255,255,.06);border:1px solid var(--border);border-radius:6px;overflow:hidden}
  .shieldbar>.fill{height:100%;background:#7cc7ff}
  .canvasWrap{width:100%;background:#000;border:1px solid var(--border);border-radius:18px;padding:10px;box-shadow:var(--card)}
  canvas{display:block;margin:0 auto;border-radius:12px;background:#000}
  .footer{margin:6px auto 0;text-align:center;font-size:12px;color:var(--muted)}
  .lb-list{list-style:none;margin:8px 0 0;padding:0;font:12px ui-monospace,Consolas,Menlo,monospace}
  .lb-list li{display:flex;justify-content:space-between;border-bottom:1px dotted var(--border);padding:3px 0}
</style>
</head>
<body>
  <h1>MataTudo — Alpha 15.2</h1>
  <div class="wrap">
    <!-- LEFT -->
    <div class="panel">
      <div class="kv"><div>Score</div><div id="uiScore">0</div></div>
      <div class="kv"><div>Best</div><div id="uiBest">0</div></div>
      <div class="kv"><div>Level</div><div id="uiLevel">1</div></div>
      <div class="kv"><div>Mult</div><div id="uiMult">x1</div></div>
      <div class="kv"><div>Power</div><div id="uiPower">-</div></div>
      <div class="card">
        <div class="muted" style="font-size:12px;margin-bottom:4px">HP</div>
        <div class="hpbar"><div id="hpFill" class="fill" style="width:100%"></div></div>
        <div class="shieldbar"><div id="shFill" class="fill" style="width:0%"></div></div>
      </div>
      <div class="card">
        <div class="muted" style="font-weight:700;margin-bottom:6px">Tips</div>
        <div class="muted" style="white-space:pre-line;font-size:12px;line-height:1.3">• WASD / Arrows move
• Mouse aims • Click shoots (hold)
• M mute • R restart
• SPACE starts
• Level +1 every 30 kills
• Boss at 5,15,25,40,55,75…</div>
      </div>
      <div class="card">
        <div class="row">
          <button id="btnMute" class="btn">Mute</button>
          <span class="muted">Vol</span>
          <input id="rngVol" class="range" type="range" min="0" max="1" step="0.05" value="0.7"/>
        </div>
      </div>
      <div class="card"><button id="btnPause" class="btn" style="width:100%">Pause</button></div>
    </div>

    <!-- CENTER -->
    <div class="canvasWrap">
      <canvas id="game" width="980" height="560"></canvas>
      <div class="footer">Press <b>SPACE</b> to start • Retro toggle on the right • Obstacles fade & boss fights (A14.2 feel)</div>
    </div>

    <!-- RIGHT -->
    <div class="panel">
      <div class="card">
        <div class="kv"><strong>Leaderboards</strong><span class="muted">Local</span></div>
        <div class="kv"><span>All‑Time (Local)</span><span id="uiAllTime">0</span></div>
        <div class="kv"><span>Your Best</span><span id="uiBest2">0</span></div>
        <div class="muted" style="margin-top:6px">Top 10</div>
        <ul id="uiTop10" class="lb-list"></ul>
      </div>
      <div class="card">
        <div class="kv"><strong>Retro Mode</strong><span class="muted">On</span></div>
        <label class="row" style="justify-content:space-between">
          <span class="muted">Greyscale + scanlines vibe</span>
          <input id="retroToggle" type="checkbox"/>
        </label>
      </div>
    </div>
  </div>

<script>
(() => {
  // ---------- Canvas & UI ----------
  const cvs = document.getElementById('game');
  const ctx = cvs.getContext('2d', {alpha:false});
  const W=cvs.width, H=cvs.height;

  const ui = {
    score: document.getElementById('uiScore'),
    best: document.getElementById('uiBest'),
    best2: document.getElementById('uiBest2'),
    level: document.getElementById('uiLevel'),
    mult:  document.getElementById('uiMult'),
    hpFill:document.getElementById('hpFill'),
    shFill:document.getElementById('shFill'),
    btnPause:document.getElementById('btnPause'),
    btnMute: document.getElementById('btnMute'),
    rngVol:  document.getElementById('rngVol'),
    retro:   document.getElementById('retroToggle'),
    top10:   document.getElementById('uiTop10'),
    allTime: document.getElementById('uiAllTime')
  };

  // ---------- Audio (loop + sting) ----------
  const MUSIC_URL="https://raw.githubusercontent.com/esteves7771/MataTudo/main/retro-synthwave-gaming-music-270173.mp3";
  const STING_URL ="https://raw.githubusercontent.com/esteves7771/MataTudo/main/victory-awaits-in-the-gaming-universe_astronaut-265184.mp3";
  const music = new Audio(MUSIC_URL); music.loop=true; music.preload='auto'; music.crossOrigin='anonymous';
  const sting = new Audio(STING_URL); sting.loop=false; sting.preload='auto'; sting.crossOrigin='anonymous';

  // ---------- State (A14.2 feel) ----------
  const s = {
    mode:'menu', last:0, countdown:2,
    p:{x:W/2,y:H/2,r:12,hp:100,sh:0,shMax:2,spd:240,cd:0,flash:0,hit:0},
    keys:Object.create(null), mouse:{x:W/2,y:H/2,down:false},
    bullets:[], bots:[], parts:[], kits:[],
    obstacles:seedObstacles(), obsPhase:'stable', obsT:0, obsA:1,
    spawnT:0, score:0, best:0, level:1, kills:0,
    boss:null, bossActive:false, bossIdx:0, postBoss:0,
    bossSchedule:[5,15,25,40,55,75,90,110,130,170,200,230,250],
    muted:false, volume:0.7,
    retro:false,
    top10:loadTop10()
  };

  // restore settings
  try{ s.best = parseInt(localStorage.getItem('mt_best')||'0',10)||0; }catch{}
  try{ s.retro = (localStorage.getItem('mt_visual_mode')==='retro'); }catch{}
  document.documentElement.setAttribute('data-theme', s.retro?'retro':'normal');
  ui.retro.checked = s.retro;

  // ---------- Helpers ----------
  const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
  function seedObstacles(){
    return [
      {x:280,y:180,w:90,h:90},
      {x:610,y:340,w:120,h:70},
      {x:440,y: 90,w:70,h:70},
      {x:120,y:400,w:140,h:40},
    ];
  }
  function rectCircle(cx,cy,r,o){ const nx=clamp(cx,o.x,o.x+o.w), ny=clamp(cy,o.y,o.y+o.h); const dx=cx-nx,dy=cy-ny; return dx*dx+dy*dy<=r*r; }
  function bulletHits(b,o){ return (b.x+b.r>o.x && b.x-b.r<o.x+o.w && b.y+b.r>o.y && b.y-b.r<o.y+o.h); }
  function posFree(x,y,r){ if(x<12+r||x>W-12-r||y<12+r||y>H-12-r)return false; return !s.obstacles.some(o=>rectCircle(x,y,r,o)); }
  function addParts(x,y,c,n=12,sz=2,spd=120){ for(let i=0;i<n;i++){ const a=Math.random()*Math.PI*2, v=spd*(.5+Math.random()); s.parts.push({x,y,vx:Math.cos(a)*v,vy:Math.sin(a)*v,t:.5+.4*Math.random(),c,sz}); } }

  // ---------- Right panel: Top‑10 (local) ----------
  function loadTop10(){ try{ const raw=localStorage.getItem('mt_top10'); const arr=raw?JSON.parse(raw):[]; return Array.isArray(arr)?arr.slice(0,10):[]; }catch{ return [] } }
  function saveTop10(){ try{ localStorage.setItem('mt_top10', JSON.stringify(s.top10.slice(0,10))); }catch{} }
  function pushScore(name,score){ s.top10.push({name,score}); s.top10.sort((a,b)=>b.score-a.score); s.top10=s.top10.slice(0,10); saveTop10(); renderTop10(); }
  function renderTop10(){
    ui.top10.innerHTML='';
    if(!s.top10.length){ const li=document.createElement('li'); li.innerHTML='<span>—</span><span>0</span>'; ui.top10.appendChild(li); ui.allTime.textContent=String(s.best||0); return; }
    ui.allTime.textContent=String(s.top10[0].score||0);
    s.top10.forEach((r,i)=>{ const li=document.createElement('li'); li.innerHTML=`<span>${String(i+1).padStart(2,'0')} · ${escapeHTML(r.name||'anon')}</span><span>${r.score}</span>`; ui.top10.appendChild(li); });
  }
  function escapeHTML(t){return String(t).replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]))}
  renderTop10();

  // ---------- Name prompt ----------
  let nameUI=null;
  function namePrompt(){
    if(nameUI) nameUI.remove();
    const b=document.createElement('div');
    b.style.position='fixed'; b.style.inset='0'; b.style.display='grid'; b.style.placeItems='center'; b.style.background='rgba(0,0,0,.55)';
    b.innerHTML=`<div style="background:var(--panel);border:1px solid var(--border);padding:16px;border-radius:14px;width:min(420px,90vw);box-shadow:var(--card)">
      <div style="font-weight:700;margin-bottom:8px">New Score: ${s.score}</div>
      <div class="muted" style="margin-bottom:6px">Enter your name for the local Top 10:</div>
      <input id="nm" type="text" maxlength="16" style="width:100%;padding:8px 10px;border-radius:10px;border:1px solid var(--border);background:var(--panel2);color:var(--text)"/>
      <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px">
        <button id="skip" class="btn">Skip</button><button id="save" class="btn">Save</button>
      </div></div>`;
    document.body.appendChild(b); nameUI=b;
    const nm=b.querySelector('#nm'), sv=b.querySelector('#save'), sk=b.querySelector('#skip');
    nm.focus(); nm.addEventListener('keydown',e=>{ e.stopPropagation(); if(e.key==='Enter')doSave(); });
    sv.addEventListener('click',e=>{ e.stopPropagation(); doSave(); });
    sk.addEventListener('click',e=>{ e.stopPropagation(); close(); });
    function doSave(){ pushScore(nm.value.trim()||'anon', s.score); close(); }
    function close(){ if(nameUI){ nameUI.remove(); nameUI=null; } }
  }

  // ---------- UI actions ----------
  ui.btnPause.addEventListener('click',()=>{ if(s.mode==='playing'){ enterMenu(); } else if(s.mode==='menu'){ startGame(); } });
  ui.btnMute.addEventListener('click',()=>{ s.muted=!s.muted; ui.btnMute.textContent=s.muted?'Unmute':'Mute'; applyVolumes(); });
  ui.rngVol.addEventListener('input',()=>{ s.volume=parseFloat(ui.rngVol.value); applyVolumes(); });
  ui.retro.addEventListener('change',()=>{ s.retro=ui.retro.checked; document.documentElement.setAttribute('data-theme', s.retro?'retro':'normal'); try{ localStorage.setItem('mt_visual_mode', s.retro?'retro':'normal'); }catch{} });

  function applyVolumes(){
    music.volume = s.muted?0:s.volume;
    sting.volume = s.muted?0:Math.min(0.8,s.volume*0.9);
  }
  applyVolumes();

  // ---------- Input ----------
  function isEditing(){ const el=document.activeElement; return el && (el.tagName==='INPUT'||el.tagName==='TEXTAREA'||el.isContentEditable); }
  window.addEventListener('keydown',(e)=>{
    const k=e.key.toLowerCase();
    if (isEditing()){
      if (e.code==='Space' && (s.mode==='menu'||s.mode==='gameover')){ e.preventDefault(); startGame(); }
      if (k==='r' && s.mode==='gameover'){ e.preventDefault(); startGame(); }
      return;
    }
    if (!e.repeat) s.keys[k]=true;
    if (k==='m'){ s.muted=!s.muted; ui.btnMute.textContent=s.muted?'Unmute':'Mute'; applyVolumes(); }
    if (s.mode==='menu' && e.code==='Space'){ startGame(); }
    if (s.mode==='gameover' && (k==='r'||e.code==='Space')){ startGame(); }
  });
  window.addEventListener('keyup',e=>{ s.keys[e.key.toLowerCase()]=false; });

  function toLocal(e){ const r=cvs.getBoundingClientRect(); s.mouse.x=(e.clientX-r.left)*(W/r.width); s.mouse.y=(e.clientY-r.top)*(H/r.height); }
  cvs.addEventListener('mousemove',toLocal);
  cvs.addEventListener('mousedown',e=>{ toLocal(e); s.mouse.down=true; if(s.mode==='menu') startGame(); });
  window.addEventListener('mouseup',()=>{ s.mouse.down=false; });

  // ---------- Start / Menu ----------
  function startGame(){
    try{ music.currentTime=0; if(!s.muted) music.play().catch(()=>{}); }catch{}
    try{ sting.pause(); }catch{}
    s.mode='countdown'; s.countdown=2;
    s.p={x:W/2,y:H/2,r:12,hp:100,sh:0,shMax:2,spd:240,cd:0,flash:0,hit:0};
    s.bullets.length=0; s.bots.length=0; s.parts.length=0; s.kits.length=0;
    s.obstacles=seedObstacles(); s.obsPhase='stable'; s.obsT=0; s.obsA=1;
    s.spawnT=0; s.score=0; s.level=1; s.kills=0;
    s.boss=null; s.bossActive=false; s.bossIdx=0; s.postBoss=0;
  }
  function enterMenu(){
    s.mode='menu';
    s.bullets.length=0; s.parts.length=0; s.kits.length=0;
    try{ music.pause(); music.currentTime=0; }catch{}
  }

  // ---------- Boss (A14.2 patterns) ----------
  function bossHPForIndex(i){ const base=360; return Math.floor(base*Math.pow(1.2,i)); }
  function spawnBoss(){
    s.bossActive=true;
    s.bullets=s.bullets.filter(b=>b.owner==='p'); // wipe enemy shots
    const hp=bossHPForIndex(s.bossIdx);
    const bx=clamp(W/2 + (Math.random()*160-80), 60, W-60);
    const by=clamp(H/2 + (Math.random()*120-60), 60, H-60);
    s.boss={x:bx,y:by,r:22,hp,max:hp,phase:1,cd:0,tele:0,dir:0};
  }
  function updateBoss(dt){
    if(!s.bossActive) return;
    const b=s.boss, p=s.p; if(!b) return;

    if(b.phase===1 && b.hp<=b.max*0.5){ b.phase=2; b.tele=0.9; }

    if(b.phase===1){
      const a=Math.atan2(p.y-b.y,p.x-b.x);
      b.x=clamp(b.x+Math.cos(a)*90*dt,24+b.r,W-24-b.r);
      b.y=clamp(b.y+Math.sin(a)*90*dt,24+b.r,H-24-b.r);
      b.cd-=dt;
      if(b.cd<=0){
        const spread=0.18;
        for(let k=-1;k<=1;k+=2){
          const ang=a+k*spread;
          s.bullets.push({x:b.x,y:b.y,vx:Math.cos(ang)*420,vy:Math.sin(ang)*420,r:4,owner:'B',life:2.5});
        }
        b.cd=0.55;
      }
    }else{
      if(b.tele>0){ b.tele-=dt; }
      else if(b.tele<=0 && Math.random()<0.006){ b.tele=0.9; b.dir=Math.atan2(p.y-b.y,p.x-b.x); }
      if(b.tele>0){
        const a=Math.atan2(p.y-b.y,p.x-b.x);
        b.x=clamp(b.x+Math.cos(a)*60*dt,24+b.r,W-24-b.r);
        b.y=clamp(b.y+Math.sin(a)*60*dt,24+b.r,H-24-b.r);
      }else{
        b.x=clamp(b.x+Math.cos(b.dir)*800*dt,24+b.r,W-24-b.r);
        b.y=clamp(b.y+Math.sin(b.dir)*800*dt,24+b.r,H-24-b.r);
      }
      b.cd-=dt;
      if(b.cd<=0){
        const a=Math.atan2(p.y-b.y,p.x-b.x), spread=0.22;
        for(let i=-1;i<=1;i++){ const ang=a+i*spread;
          s.bullets.push({x:b.x,y:b.y,vx:Math.cos(ang)*480,vy:Math.sin(ang)*480,r:4,owner:'B',life:2.3});
        }
        b.cd=0.42;
      }
    }

    // boss hits
    for(const pr of s.bullets){
      if(pr.owner!=='p') continue;
      const d=(b.x-pr.x)*(b.x-pr.x)+(b.y-pr.y)*(b.y-pr.y);
      if(d <= (b.r+pr.r)*(b.r+pr.r)){
        b.hp-=25; pr.life=0; addParts(b.x,b.y,'#ff9b9b',16,2.2,140);
        if(b.hp<=0){
          s.score+=10; s.kills+=5;
          s.p.hp=Math.min(100,s.p.hp+35);
          if(s.p.sh<s.p.shMax) s.p.sh++;
          s.boss=null; s.bossActive=false; s.bossIdx++; s.postBoss=4; addParts(b.x,b.y,'#ffd372',50,3,180);
          break;
        }
      }
    }
    // boss bullets -> player
    for(const pr of s.bullets){
      if(pr.owner!=='B') continue;
      const d=(s.p.x-pr.x)*(s.p.x-pr.x)+(s.p.y-pr.y)*(s.p.y-pr.y);
      if(d <= (s.p.r+pr.r)*(s.p.r+pr.r)){ pr.life=0; hitPlayer(14); }
    }
  }

  // ---------- Obstacles fade (A14.2) ----------
  function randomObstacles(){
    const MAX_W=220, MAX_H=140, n=4+Math.floor(Math.random()*3); const out=[];
    for(let i=0;i<n;i++){
      const w=60+Math.random()*MAX_W, h=40+Math.random()*Math.min(MAX_H,MAX_W);
      const x=clamp(36+Math.random()*(W-72-w),24,W-24-w);
      const y=clamp(36+Math.random()*(H-72-h),24,H-24-h);
      out.push({x,y,w,h});
    }
    const safe={x:s.p.x-80,y:s.p.y-80,w:160,h:160};
    const bad=out.some(o=>!(safe.x+safe.w<o.x||safe.x>o.x+o.w||safe.y+safe.h<o.y||safe.y>o.y+o.h));
    return bad? s.obstacles: out;
  }
  function triggerObs(){ s.obsPhase='fadeOut'; s.obsT=0; }
  function updateObs(dt){
    if(s.obsPhase==='stable') return;
    const DUR=.45; s.obsT+=dt; const t=clamp(s.obsT/DUR,0,1);
    if(s.obsPhase==='fadeOut'){ s.obsA=1-t; if(s.obsT>=DUR){ s.obstacles=randomObstacles(); s.obsPhase='fadeIn'; s.obsT=0; } }
    else{ s.obsA=t; if(s.obsT>=DUR){ s.obsPhase='stable'; s.obsA=1; } }
  }

  // ---------- Gameplay ----------
  function trySpawnKit(){
    if(s.kills>0 && s.kills%25===0 && !s.kits.some(k=>k.tag==='k'+s.kills)){
      for(let i=0;i<60;i++){
        const r=10, x=20+Math.random()*(W-40), y=20+Math.random()*(H-40);
        if(!posFree(x,y,r)) continue; s.kits.push({x,y,r,t:20,tag:'k'+s.kills}); break;
      }
    }
  }
  function hitPlayer(dmg){
    if(s.p.sh>0){ const take=Math.min(dmg,25); dmg-=take; if(take>=25) s.p.sh--; }
    if(dmg>0){ s.p.hp-=dmg; s.p.hit=.25; addParts(s.p.x,s.p.y,'#ff6666',10,2,140); }
  }

  // ---------- Loop ----------
  function update(dt){
    // UI mirrors
    ui.score.textContent=s.score; ui.best.textContent=s.best; ui.best2.textContent=s.best; ui.level.textContent=s.level; ui.mult.textContent='x1';
    ui.hpFill.style.width=`${clamp(s.p.hp,0,100)}%`; ui.shFill.style.width=`${clamp(s.p.sh*25,0,50)}%`;
    updateObs(dt);

    if(s.mode==='menu') return;
    if(s.mode==='countdown'){ s.countdown-=dt; if(s.countdown<=0) s.mode='playing'; return; }
    if(s.mode!=='playing') return;

    // level & bosses (compute new level before spawn check)
    const newLevel = Math.floor(s.kills/30)+1;
    if(newLevel> s.level){ s.level=newLevel; if(!s.bossActive) triggerObs(); }

    if(!s.bossActive && s.bossIdx < s.bossSchedule.length && s.level === s.bossSchedule[s.bossIdx]){
      spawnBoss();
    }

    if(s.postBoss>0) s.postBoss -= dt;

    // spawns (paused during boss & postBoss)
    if(!s.bossActive && s.postBoss<=0){
      s.spawnT -= dt;
      const base=Math.max(0.5,1.6-Math.min(60,s.score/5)*0.01);
      const scaled=Math.max(0.28, base*(1-0.06*(s.level-1)));
      if(s.spawnT<=0){ const eliteChance=Math.min(0.45,0.04*s.level); spawnBot(Math.random()<eliteChance); s.spawnT=scaled; }
    }

    // move
    const k=s.keys,p=s.p; let ix=0,iy=0; if(k['w']||k['arrowup'])iy--; if(k['s']||k['arrowdown'])iy++; if(k['a']||k['arrowleft'])ix--; if(k['d']||k['arrowright'])ix++;
    const m=Math.hypot(ix,iy)||1, mx=ix/m*p.spd*dt, my=iy/m*p.spd*dt;
    let nx=clamp(p.x+mx,12+p.r,W-12-p.r); if(!s.obstacles.some(o=>rectCircle(nx,p.y,p.r,o))) p.x=nx;
    let ny=clamp(p.y+my,12+p.r,H-12-p.r); if(!s.obstacles.some(o=>rectCircle(p.x,ny,p.r,o))) p.y=ny;
    p.cd-=dt; p.flash=Math.max(0,p.flash-dt); p.hit=Math.max(0,p.hit-dt);

    // shoot (hold)
    if(s.mouse.down && p.cd<=0){
      const dx=s.mouse.x-p.x, dy=s.mouse.y-p.y, d=Math.hypot(dx,dy)||1, a=Math.atan2(dy,dx);
      s.bullets.push({x:p.x,y:p.y,vx:dx/d*520,vy:dy/d*520,r:3,owner:'p',life:2});
      p.cd=.15; p.flash=.07; addParts(p.x+Math.cos(a)*p.r,p.y+Math.sin(a)*p.r,'#fff8',5,1.5,90);
    }

    // bots
    s.bots.forEach(b=>{
      b.j=(b.j||0)+dt*2.2; const a=Math.atan2(p.y-b.y,p.x-b.x)+Math.sin(b.j)*0.25;
      const sx=Math.cos(a)*b.spd*dt, sy=Math.sin(a)*b.spd*dt;
      let tx=b.x+sx; if(!s.obstacles.some(o=>rectCircle(tx,b.y,b.r,o))) b.x=clamp(tx,12+b.r,W-12-b.r);
      let ty=b.y+sy; if(!s.obstacles.some(o=>rectCircle(b.x,ty,b.r,o))) b.y=clamp(ty,12+b.r,H-12-b.r);
      b.cd-=dt; if(b.cd<=0){ const ang=Math.atan2(p.y-b.y,p.x-b.x)+(Math.random()-0.5)*0.18; s.bullets.push({x:b.x,y:b.y,vx:Math.cos(ang)*360,vy:Math.sin(ang)*360,r:3,owner:'b',life:2}); b.cd=(b.elite?0.7:0.9)*(0.95-0.03*(s.level-1)); }
    });

    // bullets
    s.bullets.forEach(b=>{ b.x+=b.vx*dt; b.y+=b.vy*dt; b.life-=dt; });
    s.bullets = s.bullets.filter(b=>b.life>0 && b.x>-10 && b.x<W+10 && b.y>-10 && b.y<H+10 && !s.obstacles.some(o=>bulletHits(b,o)));

    // hits: player bullets -> bots
    s.bots = s.bots.filter(b=>{
      let alive=true;
      for(const pr of s.bullets){
        if(pr.owner!=='p') continue;
        const d=(b.x-pr.x)*(b.x-pr.x)+(b.y-pr.y)*(b.y-pr.y);
        if(d <= (b.r+pr.r)*(b.r+pr.r)){
          b.hp-=25; pr.life=0; addParts(b.x,b.y,b.elite?'#ffd372':'#ff7b72',12,2,140);
          if(b.hp<=0){ alive=false; s.score += b.elite?2:1; s.kills++; trySpawnKit(); }
        }
      }
      return alive;
    });

    // bot bullets -> player
    for(const pr of s.bullets){
      if(pr.owner!=='b') continue;
      const d=(s.p.x-pr.x)*(s.p.x-pr.x)+(s.p.y-pr.y)*(s.p.y-pr.y);
      if(d <= (s.p.r+pr.r)*(s.p.r+pr.r)){ pr.life=0; hitPlayer(10); }
    }

    // boss
    if(s.bossActive) updateBoss(dt);

    // kits
    s.kits.forEach(k=>k.t-=dt);
    s.kits = s.kits.filter(k=>{
      if(k.t<=0) return false;
      if(Math.hypot(k.x-s.p.x,k.y-s.p.y) < k.r+s.p.r){
        s.p.hp=Math.min(100,s.p.hp+30); addParts(k.x,k.y,'#8cff8c',16,2.5,120); return false;
      } return true;
    });

    // death
    if(s.p.hp<=0){
      s.mode='gameover';
      try{ music.pause(); music.currentTime=0; }catch{}
      try{ if(!s.muted){ sting.currentTime=0; sting.play().catch(()=>{}); } }catch{}
      if(s.score > s.best){ s.best=s.score; try{ localStorage.setItem('mt_best', String(s.best)); }catch{} }
      requestAnimationFrame(namePrompt);
    }
  }

  function draw(){
    ctx.save(); try{ ctx.filter = s.retro?'grayscale(100%) contrast(112%) brightness(96%)':'none'; }catch{}
    ctx.fillStyle='#0b1320'; ctx.fillRect(0,0,W,H); ctx.restore();
    ctx.strokeStyle='rgba(255,255,255,.18)'; ctx.strokeRect(12,12,W-24,H-24);

    // obstacles
    ctx.save(); ctx.globalAlpha=s.obsA;
    s.obstacles.forEach(o=>{ ctx.fillStyle='#4b5563'; ctx.fillRect(o.x,o.y,o.w,o.h); ctx.strokeStyle='rgba(0,0,0,.25)'; ctx.strokeRect(o.x+0.5,o.y+0.5,o.w-1,o.h-1); });
    ctx.restore();

    const showEntities = s.mode!=='menu';

    // medkits
    if(showEntities){
      s.kits.forEach(m=>{ const blink = m.t<5 ? (Math.floor(m.t*10)%2===0) : true; if(!blink) return; const r=m.r;
        ctx.fillStyle='#e5f7ff'; ctx.fillRect(m.x-r,m.y-r,r*2,r*2);
        ctx.strokeStyle='#94a3b8'; ctx.strokeRect(m.x-r+0.5,m.y-r+0.5,r*2-1,r*2-1);
        ctx.fillStyle='#e11d48'; ctx.fillRect(m.x-r*0.25,m.y-r*0.8,r*0.5,r*1.6); ctx.fillRect(m.x-r*0.8,m.y-r*0.25,r*1.6,r*0.5);
      });
    }

    // player
    const p=s.p, ang=Math.atan2(s.mouse.y-p.y,s.mouse.x-p.x);
    if(showEntities) drawSoldier(p.x,p.y,ang,p.r,p.flash,p.sh>0);

    // bots
    if(showEntities){
      s.bots.forEach(b=>{ ctx.fillStyle=b.elite?'#f0c420':'#ff7b72'; ctx.beginPath(); ctx.arc(b.x,b.y,b.r,0,Math.PI*2); ctx.fill();
        const f=Math.max(0,b.hp)/(b.elite?80:40); ctx.strokeStyle='rgba(255,255,255,.65)'; ctx.lineWidth=2; ctx.beginPath(); ctx.arc(b.x,b.y,b.r+4,-Math.PI/2,-Math.PI/2+f*Math.PI*2); ctx.stroke();
      });
    }

    // boss
    if(s.bossActive && s.boss){
      const b=s.boss;
      if(b.phase===2 && b.tele>0){ ctx.save(); ctx.shadowColor='rgba(255,80,80,.9)'; ctx.shadowBlur=20; ctx.fillStyle='#ef4444'; ctx.beginPath(); ctx.arc(b.x,b.y,b.r+2,0,Math.PI*2); ctx.fill(); ctx.restore(); }
      else { ctx.fillStyle='#ef4444'; ctx.beginPath(); ctx.arc(b.x,b.y,b.r,0,Math.PI*2); ctx.fill(); }
      // mini HP
      const w=160,h=8,x=20,y=24; ctx.fillStyle='rgba(255,255,255,.08)'; ctx.fillRect(x,y,w,h); ctx.fillStyle='#ff7a7a';
      const frac=clamp(b.hp/b.max,0,1); ctx.fillRect(x,y,w*frac,h); ctx.strokeStyle='rgba(255,255,255,.25)'; ctx.strokeRect(x+0.5,y+0.5,w-1,h-1);
    }

    // bullets & particles
    if(showEntities){
      s.bullets.forEach(b=>{ ctx.fillStyle=(b.owner==='p')?'#e6ff71':(b.owner==='B'?'#ff9b9b':'#ffa8a3'); ctx.beginPath(); ctx.arc(b.x,b.y,b.r,0,Math.PI*2); ctx.fill(); });
      s.parts.forEach(pt=>{ ctx.fillStyle=pt.c; ctx.beginPath(); ctx.arc(pt.x,pt.y,pt.sz,0,Math.PI*2); ctx.fill(); });
    }

    // overlays
    ctx.fillStyle='#fff'; ctx.textAlign='center';
    if(s.mode==='menu'){
      ctx.fillStyle='rgba(0,0,0,.55)'; ctx.fillRect(0,0,W,H);
      ctx.fillStyle='#fff'; ctx.font='bold 38px ui-sans-serif,system-ui'; ctx.fillText('MataTudo', W/2, H/2-40);
      ctx.font='16px ui-sans-serif,system-ui'; ctx.fillText('Press SPACE or Click to start', W/2, H/2); ctx.fillText(`Best: ${s.best}`, W/2, H/2+28);
    }else if(s.mode==='countdown'){
      ctx.fillStyle='rgba(0,0,0,.35)'; ctx.fillRect(0,0,W,H);
      ctx.fillStyle='#fff'; ctx.font='bold 48px ui-sans-serif,system-ui'; ctx.fillText(String(Math.max(1,Math.ceil(s.countdown))), W/2, H/2);
    }else if(s.mode==='gameover'){
      ctx.fillStyle='rgba(0,0,0,.65)'; ctx.fillRect(0,0,W,H);
      ctx.fillStyle='#fff'; ctx.font='bold 28px ui-sans-serif,system-ui'; ctx.fillText('Game Over', W/2, H/2-20);
      ctx.font='16px ui-sans-serif,system-ui'; ctx.fillText(`Score: ${s.score}   Best: ${s.best}`, W/2, H/2+10);
      ctx.fillText('Press R or SPACE (or click) to restart', W/2, H/2+36);
    }
    ctx.textAlign='start';
  }

  function drawSoldier(x,y,a,r,flash,shield){
    ctx.save(); ctx.translate(x,y); ctx.rotate(a);
    if (shield){ ctx.globalAlpha=.85; ctx.strokeStyle='rgba(120,200,255,.95)'; ctx.lineWidth=2.5; ctx.beginPath(); ctx.arc(0,0,r+5,0,Math.PI*2); ctx.stroke(); ctx.globalAlpha=1; }
    ctx.fillStyle='rgba(0,0,0,.25)'; ctx.beginPath(); ctx.ellipse(0,r*0.9,r*0.9,r*0.4,0,0,Math.PI*2); ctx.fill();
    const g=ctx.createRadialGradient(0,-r*0.2,r*0.2,0,0,r*1.05); g.addColorStop(0,'#34d27a'); g.addColorStop(1,'#228d4e');
    ctx.fillStyle=g; ctx.beginPath(); ctx.arc(0,0,r,0,Math.PI*2); ctx.fill();
    ctx.fillStyle='#1e824c'; ctx.beginPath(); ctx.arc(0,-r*0.3,r*0.95,Math.PI,0); ctx.fill();
    ctx.fillStyle='#145a32'; ctx.fillRect(-r,-r*0.3,r*2,r*0.15);
    ctx.fillStyle='#2ecc71'; ctx.fillRect(-r*1.2,-r*0.4,r*0.4,r*1.2); ctx.fillRect(r*0.8,-r*0.4,r*0.4,r*1.2);
    ctx.fillStyle='#dcdcdc'; ctx.fillRect(0,-3,r+14,6); ctx.fillStyle='#555'; ctx.fillRect(r+14,-2,4,4);
    if (flash>0){ ctx.fillStyle='rgba(255,240,120,.9)'; ctx.beginPath(); ctx.ellipse(r+20,0,7,3.5,0,0,Math.PI*2); ctx.fill(); }
    ctx.restore();
  }

  function spawnBot(elite=false){
    const r=elite?14:12; let x=0,y=0,tries=0;
    while(tries++<40){
      const edge=Math.floor(Math.random()*4);
      if(edge===0){x=12+r;y=Math.random()*H;} else if(edge===1){x=W-12-r;y=Math.random()*H;}
      else if(edge===2){x=Math.random()*W;y=12+r;} else {x=Math.random()*W;y=H-12-r;}
      if(posFree(x,y,r)) break;
    }
    const hp=elite?80:40, spd=(elite?120:95);
    s.bots.push({x,y,r,hp,spd,cd:Math.random()*0.6+0.8,elite});
  }

  // main loop
  function step(t){
    const dt=Math.min(.033,(t-(s.last||t))/1000); s.last=t;
    update(dt); draw();
    requestAnimationFrame(step);
  }
  requestAnimationFrame(step);

  // click start
  cvs.addEventListener('click',()=>{ if(s.mode==='menu') startGame(); });

  // on gameover: play sting (handled already) + open prompt
  // no extra code here

})();
</script>
</body>
</html>
